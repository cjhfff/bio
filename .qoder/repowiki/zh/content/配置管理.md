# 配置管理

<cite>
**本文档中引用的文件**  
- [config.py](file://app/config.py)
- [README.md](file://README.md)
- [cli.py](file://app/cli.py)
- [filtering.py](file://app/filtering.py)
- [ranking.py](file://app/ranking.py)
- [pushplus.py](file://app/push/pushplus.py)
- [pubmed.py](file://app/sources/pubmed.py)
</cite>

## 目录
1. [简介](#简介)
2. [配置项详解](#配置项详解)
3. [配置优先级机制](#配置优先级机制)
4. [研究方向关键词配置](#研究方向关键词配置)
5. [排除关键词配置](#排除关键词配置)
6. [配置验证机制](#配置验证机制)
7. [最佳实践建议](#最佳实践建议)
8. [示例配置文件](#示例配置文件)
9. [结论](#结论)

## 简介
本系统通过 `config.py` 中的 `Config` 类实现统一的配置管理，支持从环境变量、`.env` 文件和代码默认值三个层级加载配置。该设计确保了系统的灵活性与安全性，适用于本地开发、测试及生产部署等多种场景。核心功能包括敏感信息保护、多环境适配、关键词过滤控制以及推送策略定制。

**Section sources**
- [config.py](file://app/config.py#L1-L134)

## 配置项详解
以下是系统中所有可配置项的详细说明，包括其用途、默认值和设置方式。

### API 密钥与服务凭证
- **DEEPSEEK_API_KEY**  
  - 用途：用于调用 DeepSeek API 生成每日智能报告  
  - 默认值：`sk-cab7a36ab0d14c9eb05267835dd886eb`（测试密钥）  
  - 设置方式：推荐通过环境变量或 `.env` 文件设置真实密钥  

- **PUBMED_EMAIL**  
  - 用途：PubMed API 请求所需的用户邮箱（NCBI 要求提供联系信息）  
  - 默认值：`1606953651@qq.com`  
  - 设置方式：可通过环境变量或 `.env` 文件覆盖  

- **PUSHPLUS_TOKENS**  
  - 用途：PushPlus 推送服务的认证令牌，支持多个 token 实现群发  
  - 默认值：`81b0e465ca8445b38117e84c90cd84aa,353188ca63a443269aea986befa6ea48`  
  - 设置方式：多个 token 使用逗号分隔，自动去除空格  

### 时间窗口与推送数量
- **DEFAULT_WINDOW_DAYS**  
  - 用途：默认抓取时间窗口（天数），用于大多数数据源  
  - 默认值：`7`  
  - 设置方式：可自定义为任意正整数  

- **EUROPEPMC_WINDOW_DAYS**  
  - 用途：Europe PMC 数据源的独立时间窗口  
  - 默认值：`7`  
  - 设置方式：独立配置，不影响其他数据源  

- **TOP_K**  
  - 用途：最终推送的论文数量上限  
  - 默认值：`5`  
  - 设置方式：CLI 或 API 调用时可动态覆盖  

- **MIN_CANDIDATES**  
  - 用途：候选论文最小数量，低于此值将触发回退策略  
  - 默认值：`10`  
  - 设置方式：影响排名逻辑，决定是否扩展搜索范围  

- **MAX_WINDOW_DAYS**  
  - 用途：最大回退时间窗口，防止过度放宽搜索条件  
  - 默认值：`30`  
  - 设置方式：作为安全边界限制回退机制  

### 日志与数据库
- **LOG_LEVEL**  
  - 用途：日志输出级别  
  - 默认值：`INFO`  
  - 可选值：`DEBUG`, `INFO`, `WARNING`, `ERROR`  

- **LOG_FILE**  
  - 用途：日志写入文件路径  
  - 默认值：`paper_push.log`  

- **DB_PATH**  
  - 用途：SQLite 数据库存储路径  
  - 默认值：`paper_push.db`  

### 推送渠道配置
- **SENDER_EMAIL** 和 **SENDER_AUTH_CODE**  
  - 用途：SMTP 邮件发送账户信息  
  - 默认值：空字符串（需手动配置）  

- **RECEIVER_EMAIL**  
  - 用途：接收推送邮件的目标地址  
  - 默认值：`1606953651@qq.com`  

- **WECOM_WEBHOOK_URL**  
  - 用途：企业微信机器人 Webhook 地址  
  - 默认值：空字符串（未启用）  

**Section sources**
- [config.py](file://app/config.py#L15-L121)

## 配置优先级机制
系统遵循明确的配置优先级规则，确保高优先级来源覆盖低优先级设置：

> **环境变量 > .env 文件 > 代码内默认值**

### 加载流程说明
1. 系统尝试导入 `python-dotenv` 并加载 `.env` 文件中的键值对到环境变量。
2. 使用 `os.getenv(key, default)` 读取配置：
   - 若环境变量存在，则使用其值；
   - 否则使用 `.env` 文件中定义的值（已通过 `load_dotenv()` 注入环境）；
   - 若两者均不存在，则使用代码中指定的默认值。

此机制允许开发者在不同环境中灵活切换配置，而无需修改源码。

**Section sources**
- [config.py](file://app/config.py#L9-L13)
- [README.md](file://README.md#L22-L26)

## 研究方向关键词配置
`RESEARCH_TOPICS` 定义了系统关注的三大核心研究方向及其关键词集合，直接影响论文检索与评分。

### 结构说明
```python
RESEARCH_TOPICS: Dict[str, List[str]] = {
    "Nitrogen_Fixation": [...],
    "Signal_Transduction": [...],
    "Enzyme_Mechanism": [...]
}
```

### 各方向关键词说明
- **Nitrogen_Fixation（生物固氮）**  
  包含“nitrogen fixation”、“rhizobia”、“nif genes”等核心术语，涵盖共生固氮、固氮酶结构与功能。

- **Signal_Transduction（信号转导）**  
  包含“signal transduction”、“receptor kinase”、“GPCR”等词，聚焦植物细胞外信号感知与传递机制。

- **Enzyme_Mechanism（酶的作用机制）**  
  包含“enzyme mechanism”、“active site”、“cryo-EM structure”等词，强调酶的结构解析与催化机理研究。

### 关键词合并逻辑
通过 `get_all_keywords()` 类方法将所有关键词合并为一个扁平列表，供全文检索使用：

```python
@classmethod
def get_all_keywords(cls) -> List[str]:
    keywords = []
    for kws in cls.RESEARCH_TOPICS.values():
        keywords.extend(kws)
    return keywords
```

该方法被多个数据源模块调用以构建查询语句。

**Section sources**
- [config.py](file://app/config.py#L27-L73)
- [pubmed.py](file://app/sources/pubmed.py#L40-L43)

## 排除关键词配置
`EXCLUDE_KEYWORDS` 用于过滤不相关或不符合研究范围的论文，提升推送质量。

### 当前排除关键词列表
```python
EXCLUDE_KEYWORDS = [
    "human", "patient", "clinical", "mouse", "mice", "rat", "rats", 
    "avian", "bird", "fish", "cancer", "tumor", "tumour", "carcinoma",
    "mammal", "vertebrate", "zebrafish", "drosophila", "therapy", 
    "treatment", "drug", "medicine", "medical", "hospital"
]
```

### 过滤机制
在 `filtering.py` 中实现关键词排除逻辑：

```python
def should_exclude_paper(paper: Paper, exclude_keywords: List[str]) -> bool:
    text_to_search = (paper.title + " " + paper.abstract).lower()
    return any(ex_keyword in text_to_search for ex_keyword in exclude_keywords)
```

该函数在数据抓取阶段被各数据源调用，确保仅保留符合领域要求的论文。

**Section sources**
- [config.py](file://app/config.py#L81-L86)
- [filtering.py](file://app/filtering.py#L9-L12)

## 配置验证机制
`Config` 类提供 `validate()` 方法用于检查关键配置项是否缺失。

### 验证逻辑
```python
@classmethod
def validate(cls) -> List[str]:
    errors = []
    if not cls.DEEPSEEK_API_KEY:
        errors.append("DEEPSEEK_API_KEY 未设置")
    if not cls.PUBMED_EMAIL:
        errors.append("PUBMED_EMAIL 未设置")
    return errors
```

### 使用场景
- 在 CLI 启动时自动调用验证；
- 在 API 接口 `/api/run` 触发任务前进行前置检查；
- 返回错误列表，便于用户快速定位问题。

该机制保障了系统运行所依赖的关键配置不会遗漏。

**Section sources**
- [config.py](file://app/config.py#L122-L130)
- [cli.py](file://app/cli.py#L23-L26)

## 最佳实践建议
为确保系统稳定运行并保护敏感信息，建议遵循以下最佳实践。

### 敏感信息保护
- 所有 API 密钥（如 `DEEPSEEK_API_KEY`）应通过环境变量设置，避免硬编码在代码中；
- 使用 `.env` 文件时，确保将其加入 `.gitignore`，防止意外提交至版本控制系统；
- 生产环境中建议使用更安全的密钥管理系统（如 Hashicorp Vault 或 AWS Secrets Manager）。

### 多环境配置管理
| 环境 | 推荐设置方式 |
|------|-------------|
| 开发环境 | 使用 `.env` 文件快速配置 |
| 测试环境 | 通过 CI/CD 环境变量注入 |
| 生产环境 | 使用容器编排平台（如 Docker/K8s）管理 secrets |

### 动态参数覆盖
支持在运行时通过命令行参数覆盖配置：
```bash
python -m app.cli run --window-days 14 --top-k 10
```
此功能适用于临时调整推送策略，不影响持久化配置。

### 配置变更影响评估
修改以下配置需谨慎评估其影响：
- `DEFAULT_WINDOW_DAYS`：增大可能导致性能下降；
- `TOP_K`：过多推送可能造成信息过载；
- `EXCLUDE_KEYWORDS`：过于严格可能导致漏检重要文献。

**Section sources**
- [README.md](file://README.md#L44-L45)
- [cli.py](file://app/cli.py#L23-L26)

## 示例配置文件
虽然项目中未提供 `.env.example` 文件，但可根据以下模板创建 `.env` 文件：

```env
# DeepSeek API 配置
DEEPSEEK_API_KEY=your_actual_api_key_here
DEEPSEEK_BASE_URL=https://api.deepseek.com

# PubMed 配置
PUBMED_EMAIL=your_email@example.com

# 推送配置
PUSHPLUS_TOKENS=token1,token2,token3
WECOM_WEBHOOK_URL=https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxxx

# 邮件配置
SENDER_EMAIL=sender@example.com
SENDER_AUTH_CODE=your_smtp_auth_code
RECEIVER_EMAIL=receiver@example.com

# 时间窗口配置
DEFAULT_WINDOW_DAYS=7
EUROPEPMC_WINDOW_DAYS=7
TOP_K=5
MIN_CANDIDATES=10
MAX_WINDOW_DAYS=30

# 数据库与日志
DB_PATH=paper_push.db
LOG_LEVEL=INFO
LOG_FILE=paper_push.log
```

保存后系统会自动加载这些配置，无需重启服务。

**Section sources**
- [README.md](file://README.md#L24-L26)

## 结论
本系统的配置管理体系设计合理，兼顾灵活性与安全性。通过 `Config` 类集中管理所有配置项，支持多层级优先级加载、运行时验证和动态覆盖。研究方向与排除关键词的结构化定义有效提升了文献筛选的准确性。建议用户根据实际需求合理配置各项参数，并遵循最佳实践保护敏感信息，确保系统长期稳定运行。