# 故障排除

<cite>
**本文档中引用的文件**  
- [logging.py](file://app/logging.py)
- [cli.py](file://app/cli.py)
- [config.py](file://app/config.py)
- [paper_push.log](file://paper_push.log)
- [biorxiv.py](file://app/sources/biorxiv.py)
- [pubmed.py](file://app/sources/pubmed.py)
- [generator.py](file://app/llm/generator.py)
- [pushplus.py](file://app/push/pushplus.py)
- [email.py](file://app/push/email.py)
- [wecom.py](file://app/push/wecom.py)
- [db.py](file://app/storage/db.py)
- [repo.py](file://app/storage/repo.py)
</cite>

## 目录
1. [日志系统与错误分析](#日志系统与错误分析)
2. [典型问题场景与解决方案](#典型问题场景与解决方案)
3. [数据源连通性测试](#数据源连通性测试)
4. [性能优化建议](#性能优化建议)

## 日志系统与错误分析

本系统使用结构化日志记录所有操作和错误信息，日志文件默认为 `paper_push.log`，配置在 `app/config.py` 中。日志级别可通过 `LOG_LEVEL` 环境变量设置（默认为 `INFO`）。

日志格式为：`时间戳 - 模块名 - 日志级别 - 消息`，便于快速定位问题来源。例如：
- `2025-12-28 09:25:26 - app.llm.generator - ERROR - 调用大语言模型时出错（第 1 次尝试）: Authentication Fails (governor)` 表示 LLM 生成模块在第一次尝试时因认证失败而报错。
- `2025-12-27 12:03:43 - app.storage.db - ERROR - 数据库操作失败: database is locked` 表示数据库操作因数据库被锁定而失败。

通过分析 `paper_push.log` 文件，可以追踪整个推送流程的执行情况、识别失败环节并获取详细的错误信息。

**Section sources**
- [logging.py](file://app/logging.py#L1-L41)
- [config.py](file://app/config.py#L118-L121)
- [paper_push.log](file://paper_push.log)

## 典型问题场景与解决方案

### 数据源抓取失败

#### 网络超时
当数据源响应缓慢或网络不稳定时，可能出现超时错误。例如，在 `app/sources/biorxiv.py` 中，`requests.get` 设置了 30 秒的超时：
```python
response = requests.get(url, timeout=30, proxies={'http': None, 'https': None})
```
如果在 30 秒内未收到响应，将抛出 `requests.exceptions.Timeout` 异常。

**解决方案**：
1. 检查网络连接是否正常。
2. 确认目标数据源（如 bioRxiv、PubMed）是否可访问。
3. 考虑在 `config.py` 中调整抓取窗口或重试机制。

#### API 限流
某些数据源（如 GitHub）对 API 调用频率有限制。例如，在 `app/sources/github.py` 中，当请求超过限制时会收到 403 错误：
```
2025-12-28 10:01:16 - app.sources.github - WARNING - GitHub 查询 'structural+biology+tool' 失败: 403 Client Error: rate limit exceeded for url: https://api.github.com/search/repositories?q=structural+biology+tool&sort=updated&order=desc&per_page=5
```

**解决方案**：
1. 避开高峰时段执行任务。
2. 在 GitHub 开发者设置中申请更高的 API 速率限制。
3. 考虑使用 GitHub 个人访问令牌（PAT）进行认证，以提高请求配额。

**Section sources**
- [biorxiv.py](file://app/sources/biorxiv.py#L40)
- [github.py](file://app/sources/github.py)
- [paper_push.log](file://paper_push.log)

### LLM 生成失败

#### API 密钥无效
LLM 生成依赖于 DeepSeek API，其密钥在 `app/config.py` 中配置。如果密钥未设置或无效，将导致认证失败：
```
2025-12-28 09:25:26 - app.llm.generator - ERROR - 调用大语言模型时出错（第 1 次尝试）: Authentication Fails (governor)
```

**解决方案**：
1. 确认 `.env` 文件中已正确设置 `DEEPSEEK_API_KEY`。
2. 在 `config.py` 的 `validate` 方法中检查密钥是否为空：
```python
@classmethod
def validate(cls) -> List[str]:
    errors = []
    if not cls.DEEPSEEK_API_KEY:
        errors.append("DEEPSEEK_API_KEY 未设置")
    return errors
```
3. 获取有效的 API 密钥并更新配置。

#### 请求超时
LLM 生成过程可能因网络延迟或模型响应慢而超时。在 `app/llm/generator.py` 中，`OpenAI` 客户端设置了 120 秒的超时：
```python
client = OpenAI(
    api_key=Config.DEEPSEEK_API_KEY,
    base_url=Config.DEEPSEEK_BASE_URL,
    timeout=120.0
)
```

**解决方案**：
1. 检查网络连接。
2. 确认 DeepSeek API 服务状态。
3. 考虑增加超时时间或优化提示词以减少生成时间。

**Section sources**
- [generator.py](file://app/llm/generator.py#L112-L116)
- [config.py](file://app/config.py#L20-L21)
- [paper_push.log](file://paper_push.log)

### 推送失败

#### 邮件服务器拒绝
邮件推送功能在 `app/push/email.py` 中实现，使用 QQ 邮箱的 SMTP 服务。如果未配置发件邮箱或授权码，将跳过发送：
```
2025-12-27 12:10:25 - app.push.email - WARNING - 未配置发送邮箱，跳过邮件发送
```

**解决方案**：
1. 在 `.env` 文件中设置 `SENDER_EMAIL` 和 `SENDER_AUTH_CODE`。
2. 确认邮箱已开启 SMTP 服务并获取正确的授权码。

#### Webhook 失效
企业微信推送通过 Webhook 实现，在 `app/push/wecom.py` 中配置。如果 Webhook URL 未设置，将跳过推送：
```
2025-12-27 12:10:25 - app.push.wecom - WARNING - 未配置企业微信Webhook，跳过推送
```

**解决方案**：
1. 在 `.env` 文件中设置 `WECOM_WEBHOOK_URL`。
2. 确认 Webhook URL 有效且未过期。

#### PushPlus 发送失败
PushPlus 推送在 `app/push/pushplus.py` 中实现，支持多个 token。如果所有 token 均发送失败，将记录错误：
```
2025-12-28 09:25:43 - app.push.pushplus - ERROR - 所有 token 均发送失败
```

**解决方案**：
1. 检查 `PUSHPLUS_TOKENS` 配置是否正确。
2. 确认 PushPlus 服务状态和 token 有效性。

**Section sources**
- [email.py](file://app/push/email.py#L16-L19)
- [wecom.py](file://app/push/wecom.py)
- [pushplus.py](file://app/push/pushplus.py#L16)
- [paper_push.log](file://paper_push.log)

## 数据源连通性测试

系统提供了 `test-sources` 命令来测试所有数据源的连通性。该命令在 `app/cli.py` 中定义：
```python
def test_sources():
    """测试所有数据源"""
    logger.info("=" * 80)
    logger.info("开始测试所有数据源")
    logger.info("=" * 80)
    
    init_db()
    repo = PaperRepository()
    sent_ids = repo.get_sent_ids()
    logger.info(f"已加载 {len(sent_ids)} 条历史记录")
    
    sources = [
        ("bioRxiv", BioRxivSource()),
        ("PubMed", PubMedSource()),
        ("RSS", RSSSource()),
        ("Europe PMC", EuropePMCSource()),
        ("Science News", ScienceNewsSource()),
        ("GitHub", GitHubSource()),
        ("Semantic Scholar", SemanticScholarSource()),
    ]
    
    results = {}
    for name, source in sources:
        logger.info(f"\n测试数据源: {name}")
        try:
            result = source.fetch(sent_ids.copy(), Config.EXCLUDE_KEYWORDS)
            success = result.success()
            count = len(result.papers)
            results[name] = {"success": success, "count": count}
            if success:
                logger.info(f"✅ {name} 测试成功，获取到 {count} 条结果")
            else:
                logger.error(f"❌ {name} 测试失败: {result.error}")
        except Exception as e:
            logger.error(f"❌ {name} 测试失败: {e}")
            results[name] = {"success": False, "count": 0}
    
    logger.info("\n" + "=" * 80)
    logger.info("测试结果汇总")
    logger.info("=" * 80)
    for name, result in results.items():
        status = "✅ 成功" if result["success"] else "❌ 失败"
        logger.info(f"{name:20s} {status:10s} 结果数: {result['count']}")
```

使用方法：
```bash
python -m app.cli test-sources
```

该命令将依次测试每个数据源，并输出详细的测试结果，帮助用户快速识别连通性问题。

**Section sources**
- [cli.py](file://app/cli.py#L170-L213)

## 性能优化建议

### 调整抓取窗口
抓取窗口天数在 `app/config.py` 中配置，可通过 `DEFAULT_WINDOW_DAYS` 和 `EUROPEPMC_WINDOW_DAYS` 环境变量调整。较小的窗口可以减少抓取的数据量，提高执行效率。

### 优化关键词列表
关键词列表在 `app/config.py` 中定义，分为三大研究方向：生物固氮、信号转导、酶机制。确保关键词精准且无冗余，可以提高抓取和筛选的效率。

### 数据库优化
系统使用 SQLite 数据库，存储在 `paper_push.db`。为避免“database is locked”错误，建议：
1. 确保没有其他进程同时访问数据库。
2. 在高并发场景下，考虑使用更强大的数据库系统。

**Section sources**
- [config.py](file://app/config.py#L109-L111)
- [db.py](file://app/storage/db.py)
- [repo.py](file://app/storage/repo.py)