# 部署指南

<cite>
**本文档中引用的文件**  
- [README.md](file://README.md)
- [deploy_to_server.md](file://deploy_to_server.md)
- [setup_server.sh](file://setup_server.sh)
- [requirements.txt](file://requirements.txt)
- [run_daily.bat](file://run_daily.bat)
- [app/config.py](file://app/config.py)
- [app/api.py](file://app/api.py)
- [app/cli.py](file://app/cli.py)
- [app/storage/db.py](file://app/storage/db.py)
- [app/logging.py](file://app/logging.py)
- [app/push/pushplus.py](file://app/push/pushplus.py)
- [app/push/email.py](file://app/push/email.py)
- [app/push/wecom.py](file://app/push/wecom.py)
</cite>

## 目录

1. [简介](#简介)
2. [本地环境部署](#本地环境部署)
3. [服务器初始化与部署](#服务器初始化与部署)
4. [API服务部署](#api服务部署)
5. [定时任务配置](#定时任务配置)
6. [日志监控与进程守护](#日志监控与进程守护)
7. [安全建议](#安全建议)
8. [故障排查](#故障排查)
9. [附录](#附录)

## 简介

本部署指南详细说明了智能论文推送系统的完整部署流程，涵盖本地开发环境和生产服务器环境的配置。系统支持从多个数据源（bioRxiv、PubMed、RSS等）抓取论文，通过AI生成报告，并通过PushPlus、邮件、企业微信等渠道推送。系统提供CLI命令行接口和FastAPI管理接口，支持定时自动运行。

**Section sources**
- [README.md](file://README.md#L1-L134)

## 本地环境部署

### 环境准备

在本地环境中部署系统需要以下步骤：

1. **克隆或下载项目**
   ```bash
   git clone <repository-url>
   cd bio
   ```

2. **创建虚拟环境（推荐）**
   ```bash
   python -m venv venv
   source venv/bin/activate  # Linux/Mac
   venv\Scripts\activate     # Windows
   ```

3. **安装依赖**
   ```bash
   pip install -r requirements.txt
   ```

4. **配置环境变量**
   ```bash
   cp .env.example .env
   # 编辑 .env 文件，填入你的API密钥等配置
   ```

### 配置文件说明

系统使用`.env`文件进行配置，主要配置项包括：

- `DEEPSEEK_API_KEY`: DeepSeek API密钥（必需）
- `PUBMED_EMAIL`: PubMed邮箱（必需）
- `PUSHPLUS_TOKENS`: PushPlus token，多个用逗号分隔
- `SENDER_EMAIL`: 发送邮箱地址
- `SENDER_AUTH_CODE`: 邮箱授权码
- `WECOM_WEBHOOK_URL`: 企业微信Webhook地址
- `DEFAULT_WINDOW_DAYS`: 默认抓取窗口（天），默认7天
- `EUROPEPMC_WINDOW_DAYS`: Europe PMC窗口（天），默认7天
- `TOP_K`: 选择Top K篇，默认5篇
- `DB_PATH`: 数据库路径，默认`paper_push.db`
- `LOG_FILE`: 日志文件路径，默认`paper_push.log`
- `LOG_LEVEL`: 日志级别，默认`INFO`

**Section sources**
- [README.md](file://README.md#L14-L94)
- [app/config.py](file://app/config.py#L1-L134)

## 服务器初始化与部署

### 服务器信息

- **IP地址**: 192.3.28.35
- **操作系统**: Ubuntu 22.04 64位（推荐）
- **初始密码**: h8Ox3dw9BbtX72P1IR

### 使用setup_server.sh脚本初始化

系统提供`setup_server.sh`脚本用于自动化服务器初始化和部署：

```bash
#!/bin/bash
# 服务器自动部署脚本

echo "========================================"
echo "生物化学研究监控系统 - 服务器部署脚本"
echo "========================================"

# 1. 更新系统
echo "步骤1: 更新系统..."
apt update && apt upgrade -y

# 2. 安装必要工具
echo "步骤2: 安装必要工具..."
apt install -y python3 python3-pip git vim tmux curl

# 3. 检查 Python 版本
echo "步骤3: 检查 Python 版本..."
python3 --version

# 4. 安装 Python 依赖
echo "步骤4: 安装 Python 依赖..."
pip3 install openai requests feedparser biopython

# 5. 创建工作目录
echo "步骤5: 创建工作目录..."
mkdir -p /root/bio_monitor
cd /root/bio_monitor

# 6. 验证安装
echo "步骤6: 验证依赖安装..."
python3 -c "import openai, requests, feedparser; from Bio import Entrez; print('✓ 所有依赖安装成功')"

# 7. 设置定时任务
echo "步骤7: 设置定时任务..."
(crontab -l 2>/dev/null; echo "0 8 * * * cd /root/bio_monitor && python3 doubao_standalone.py >> /root/bio_monitor/cron.log 2>&1") | crontab -

echo ""
echo "========================================"
echo "部署完成！"
echo "========================================"
echo "工作目录: /root/bio_monitor"
echo "定时任务: 每天早上8点运行"
echo ""
echo "下一步："
echo "1. 上传 doubao_standalone.py 到 /root/bio_monitor/"
echo "2. 运行测试: cd /root/bio_monitor && python3 doubao_standalone.py"
echo "3. 查看日志: tail -f /root/bio_monitor/cron.log"
echo "========================================"
```

### 手动部署步骤

如果选择手动部署，可按照以下步骤操作：

1. **连接服务器**
   ```bash
   ssh root@192.3.28.35
   # 输入密码: h8Ox3dw9BbtX72P1IR
   ```

2. **系统更新**
   ```bash
   apt update && apt upgrade -y
   ```

3. **安装必要工具**
   ```bash
   apt install -y python3 python3-pip git vim tmux
   ```

4. **安装Python依赖**
   ```bash
   pip3 install -r requirements.txt
   ```

5. **上传项目文件**
   ```bash
   # 在本地终端执行
   scp -r . root@192.3.28.35:/root/bio_monitor/
   ```

6. **设置权限**
   ```bash
   chmod +x setup_server.sh
   ```

**Section sources**
- [deploy_to_server.md](file://deploy_to_server.md#L1-L51)
- [setup_server.sh](file://setup_server.sh#L1-L51)

## API服务部署

### 启动API服务

系统提供FastAPI接口，可通过以下方式启动：

```bash
# 方式1：直接运行
python -m app.api

# 方式2：使用uvicorn（推荐）
uvicorn app.api:app --host 0.0.0.0 --port 8000
```

### 推荐的生产环境部署

在生产环境中，建议使用Uvicorn配合Nginx或Supervisor进行进程管理：

#### 使用Nginx反向代理

1. **安装Nginx**
   ```bash
   apt install nginx -y
   ```

2. **配置Nginx**
   ```nginx
   server {
       listen 80;
       server_name your-domain.com;
       
       location / {
           proxy_pass http://127.0.0.1:8000;
           proxy_set_header Host $host;
           proxy_set_header X-Real-IP $remote_addr;
           proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
           proxy_set_header X-Forwarded-Proto $scheme;
       }
   }
   ```

3. **重启Nginx**
   ```bash
   systemctl restart nginx
   ```

#### 使用Supervisor进程管理

1. **安装Supervisor**
   ```bash
   apt install supervisor -y
   ```

2. **创建Supervisor配置**
   ```ini
   [program:paper_push_api]
   command=/usr/bin/uvicorn app.api:app --host 0.0.0.0 --port 8000
   directory=/root/bio_monitor
   user=root
   autostart=true
   autorestart=true
   redirect_stderr=true
   stdout_logfile=/root/bio_monitor/api.log
   ```

3. **管理Supervisor**
   ```bash
   # 重新加载配置
   supervisorctl reread
   supervisorctl update
   
   # 查看状态
   supervisorctl status
   ```

### API接口说明

- `POST /api/run` - 触发推送任务
- `GET /api/runs` - 获取运行历史
- `GET /api/runs/{run_id}/scores` - 获取评分详情
- `POST /api/test-sources` - 测试数据源

**Section sources**
- [README.md](file://README.md#L47-L63)
- [app/api.py](file://app/api.py#L1-L88)

## 定时任务配置

### Linux系统（crontab）

在Linux系统中使用crontab设置定时任务：

1. **编辑crontab**
   ```bash
   crontab -e
   ```

2. **添加定时任务**
   ```bash
   # 每天早上8点运行
   0 8 * * * cd /root/bio_monitor && python3 doubao_standalone.py >> /root/bio_monitor/cron.log 2>&1

   # 每天运行两次（早8点和晚8点）
   0 8,20 * * * cd /root/bio_monitor && python3 doubao_standalone.py >> /root/bio_monitor/cron.log 2>&1
   ```

3. **常用crontab命令**
   ```bash
   # 查看定时任务
   crontab -l

   # 停止定时任务
   crontab -e
   # 在对应行前添加 # 注释掉，保存退出
   ```

### Windows系统（任务计划程序）

在Windows系统中使用任务计划程序配合`run_daily.bat`批处理文件：

1. **创建批处理文件 `run_daily.bat`**
   ```batch
   @echo off
   chcp 65001 >nul
   cd /d C:\Users\d\Desktop\worksapce\bio

   REM 设置环境变量
   set DEEPSEEK_API_KEY=sk-f49f4b863a224baebf5b3a44d7087a98
   set PUBMED_EMAIL=1606953651@qq.com
   set PUSHPLUS_TOKENS=353188ca63a443269aea986befa6ea48

   REM 执行推送任务
   python -m app.cli run

   REM 如果出错，暂停查看
   if errorlevel 1 pause
   ```

2. **在任务计划程序中创建定时任务**
   - 打开"任务计划程序"
   - 创建基本任务
   - 设置触发器为每天指定时间
   - 操作选择"启动程序"，程序为`run_daily.bat`
   - 完成设置

### CLI命令说明

系统提供CLI接口，支持以下命令：

```bash
# 执行推送任务
python -m app.cli run

# 测试数据源
python -m app.cli test-sources

# 自定义参数
python -m app.cli run --window-days 14 --top-k 10
```

**Section sources**
- [README.md](file://README.md#L30-L45)
- [deploy_to_server.md](file://deploy_to_server.md#L62-L76)
- [run_daily.bat](file://run_daily.bat#L1-L18)
- [app/cli.py](file://app/cli.py#L1-L250)

## 日志监控与进程守护

### 日志配置

系统使用结构化日志，配置如下：

```python
def setup_logging():
    """配置结构化日志"""
    log_format = "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
    date_format = "%Y-%m-%d %H:%M:%S"
    
    # 控制台输出
    console_handler = logging.StreamHandler(sys.stdout)
    console_handler.setFormatter(logging.Formatter(log_format, date_format))
    
    # 文件输出
    file_handler = logging.FileHandler(Config.LOG_FILE, encoding='utf-8')
    file_handler.setFormatter(logging.Formatter(log_format, date_format))
    
    # 根logger
    root_logger = logging.getLogger()
    root_logger.setLevel(getattr(logging, Config.LOG_LEVEL.upper(), logging.INFO))
    root_logger.addHandler(console_handler)
    root_logger.addHandler(file_handler)
    
    # 修复 Windows 控制台编码
    if sys.platform == 'win32':
        sys.stdout.reconfigure(encoding='utf-8')
        sys.stderr.reconfigure(encoding='utf-8')
    
    return root_logger
```

### 日志监控

1. **查看实时日志**
   ```bash
   tail -f paper_push.log
   ```

2. **查看定时任务日志**
   ```bash
   tail -f /root/bio_monitor/cron.log
   ```

3. **查看系统资源**
   ```bash
   # CPU和内存使用
   top
   
   # 磁盘使用
   df -h
   
   # 查看运行的 Python 进程
   ps aux | grep python
   ```

### 进程守护

#### 使用tmux

```bash
# 创建新会话
tmux new -s bio

# 在 tmux 中运行脚本
cd /root/bio_monitor
python3 doubao_standalone.py

# 分离会话（脚本继续运行）：Ctrl+B 然后按 D
# 重新连接：tmux attach -t bio
```

#### 使用Supervisor

如前所述，Supervisor可提供更可靠的进程守护。

**Section sources**
- [app/logging.py](file://app/logging.py#L1-L41)
- [deploy_to_server.md](file://deploy_to_server.md#L78-L89)

## 安全建议

### API密钥保护

1. **使用环境变量**
   - 将API密钥存储在`.env`文件中，不要硬编码在代码中
   - `.env`文件不应提交到版本控制系统

2. **限制密钥权限**
   - 为不同环境使用不同的API密钥
   - 定期轮换密钥

### 数据库文件权限

1. **设置文件权限**
   ```bash
   # 设置数据库文件权限为600
   chmod 600 paper_push.db
   
   # 设置日志文件权限为644
   chmod 644 paper_push.log
   ```

2. **备份策略**
   ```bash
   # 创建备份
   cd /root
   tar -czf bio_monitor_backup_$(date +%Y%m%d).tar.gz bio_monitor/
   
   # 下载到本地
   scp root@192.3.28.35:/root/bio_monitor_backup_*.tar.gz ./
   ```

### 服务器安全

1. **修改root密码**
   ```bash
   passwd
   # 输入新密码
   ```

2. **创建普通用户**
   ```bash
   adduser biouser
   usermod -aG sudo biouser
   # 切换到普通用户运行脚本
   su - biouser
   ```

3. **设置防火墙**
   ```bash
   apt install ufw -y
   ufw allow 22/tcp  # 允许 SSH
   ufw enable
   ```

4. **定期清理**
   ```bash
   # 清理旧的报告文件（保留最近7天）
   find /root/bio_monitor -name "生化领域突破汇总_*.txt" -mtime +7 -delete
   
   # 清理日志文件（保留最近30天）
   find /root/bio_monitor -name "*.log" -mtime +30 -delete
   ```

**Section sources**
- [deploy_to_server.md](file://deploy_to_server.md#L167-L211)

## 故障排查

### 常见问题及解决方案

#### 问题1：连接超时

```bash
# 检查网络
ping 8.8.8.8

# 检查 DNS
nslookup api.deepseek.com
```

#### 问题2：Python依赖问题

```bash
# 重新安装依赖
pip3 install --upgrade openai requests feedparser biopython
```

#### 问题3：定时任务不运行

```bash
# 检查 cron 服务
systemctl status cron

# 启动 cron 服务
systemctl start cron

# 查看 cron 日志
grep CRON /var/log/syslog
```

#### 问题4：微信推送失败

```bash
# 测试 PushPlus API
curl -X POST "https://www.pushplus.plus/send" \
  -H "Content-Type: application/json" \
  -d '{"token":"353188ca63a443269aea986befa6ea48","title":"测试","content":"测试消息"}'
```

### 配置验证

系统在启动时会验证配置：

```python
@classmethod
def validate(cls) -> List[str]:
    """验证配置，返回错误列表"""
    errors = []
    if not cls.DEEPSEEK_API_KEY:
        errors.append("DEEPSEEK_API_KEY 未设置")
    if not cls.PUBMED_EMAIL:
        errors.append("PUBMED_EMAIL 未设置")
    return errors
```

**Section sources**
- [deploy_to_server.md](file://deploy_to_server.md#L130-L166)
- [app/config.py](file://app/config.py#L123-L130)

## 附录

### 文件结构

```
/root/bio_monitor/
├── doubao_standalone.py   # 主脚本
├── sent_list.txt          # 去重数据库（自动生成）
├── sent_meta.jsonl        # 元数据记录（自动生成）
├── 生化领域突破汇总_YYYYMMDD.txt  # 报告文件（自动生成）
└── cron.log               # 定时任务日志（如果使用 cron）
```

### 数据库结构

```sql
-- papers表：论文元信息
CREATE TABLE papers (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    item_id TEXT UNIQUE NOT NULL,
    title TEXT NOT NULL,
    abstract TEXT,
    date TEXT,
    source TEXT,
    doi TEXT,
    link TEXT,
    citation_count INTEGER DEFAULT 0,
    influential_count INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- runs表：每次运行记录
CREATE TABLE runs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    run_id TEXT UNIQUE NOT NULL,
    window_days INTEGER,
    start_time TIMESTAMP,
    end_time TIMESTAMP,
    total_papers INTEGER DEFAULT 0,
    unseen_papers INTEGER DEFAULT 0,
    top_k INTEGER DEFAULT 0,
    status TEXT DEFAULT 'running',
    error TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- scores表：评分记录（可解释性）
CREATE TABLE scores (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    run_id TEXT NOT NULL,
    paper_id INTEGER NOT NULL,
    score REAL NOT NULL,
    reasons_json TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (run_id) REFERENCES runs(run_id),
    FOREIGN KEY (paper_id) REFERENCES papers(id)
);

-- pushes表：推送记录
CREATE TABLE pushes (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    run_id TEXT NOT NULL,
    paper_id INTEGER NOT NULL,
    channel TEXT NOT NULL,
    status TEXT DEFAULT 'pending',
    error TEXT,
    pushed_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (run_id) REFERENCES runs(run_id),
    FOREIGN KEY (paper_id) REFERENCES papers(id)
);

-- dedup_keys表：去重索引（快速查询）
CREATE TABLE dedup_keys (
    item_id TEXT PRIMARY KEY,
    paper_id INTEGER NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (paper_id) REFERENCES papers(id)
);
```

**Section sources**
- [deploy_to_server.md](file://deploy_to_server.md#L91-L99)
- [app/storage/db.py](file://app/storage/db.py#L48-L128)