# DOI 处理优化设计文档

## 背景与问题

### 当前实现现状

系统存在两套去重逻辑实现：

1. **BaseSource.get_item_id** (app/sources/base.py)
   - 优先级顺序：DOI → Link（哈希/原始） → Title+Source
   - 支持链接标准化和哈希去重
   - 被所有数据源的 fetch 方法调用

2. **ranking.get_item_id** (app/ranking.py)
   - 优先级顺序：DOI → Link（原始） → Title+Source
   - 不支持链接哈希去重
   - 被排序选择逻辑调用

### 核心问题识别

#### 问题一：RSS 数据源 DOI 字段缺失导致去重失败

当前 RSS 数据源在实例化 Paper 对象时，强制将 doi 字段设置为空字符串：

```
paper = Paper(
    title=entry.title,
    abstract=entry.get('summary', ''),
    date=entry.get('published', '') or entry.get('updated', ''),
    source='RSS_TopJournal',
    doi='',  # 硬编码为空字符串
    link=entry.link
)
```

**影响**：
- 同一篇文章从 RSS 和 PubMed 两个源分别获取时，RSS 版本缺少 DOI，PubMed 版本有 DOI
- 去重逻辑优先使用 DOI，当 DOI 为空时降级到 Link
- RSS feed 的 entry.id 可能包含 DOI 信息但未被利用
- 可能导致同一文章被重复推送

#### 问题二：去重逻辑实现不一致

两个 get_item_id 函数的实现存在差异：

| 特性 | BaseSource.get_item_id | ranking.get_item_id |
|------|------------------------|---------------------|
| Link 处理方式 | 支持哈希模式（可配置） | 仅原始值 |
| Title 哈希化 | 使用 SHA256 前16位 | 使用前80字符 |
| 日志输出 | 有详细调试日志 | 无日志 |
| 配置感知 | 读取 ENABLE_LINK_HASH_DEDUP | 不感知配置 |

**影响**：
- 数据源内部去重和全局去重可能得到不同结果
- 当配置启用链接哈希去重时，ranking.get_item_id 无法正确识别已去重的 ID
- 降低去重一致性和准确性

## 设计目标

### 功能目标

1. **提升 RSS 数据质量**：充分利用 RSS feed 中的 DOI 信息
2. **统一去重逻辑**：消除两个 get_item_id 实现的差异
3. **提高去重准确性**：确保跨数据源的同一文章能够正确合并

### 非功能目标

1. **向后兼容**：不影响现有已推送记录的识别
2. **可维护性**：避免代码重复，降低维护成本
3. **可扩展性**：为未来新增数据源提供统一的去重基础

## 解决方案

### 方案概览

采用三步优化策略：

1. 优化 RSS 数据源的 DOI 提取逻辑
2. 统一去重 ID 生成逻辑到 BaseSource
3. 消除 ranking.py 中的重复实现

### 详细设计

#### 1. RSS 数据源 DOI 提取增强

##### 提取策略

在 RSS feed 的 entry 对象中，DOI 可能出现在以下位置：

| 位置 | 说明 | 示例格式 |
|------|------|---------|
| entry.id | RSS 条目的唯一标识 | `https://doi.org/10.1038/xxx` 或 `doi:10.1038/xxx` |
| entry.link | 文章链接 | `https://www.nature.com/articles/xxx` |
| entry.doi | 直接 DOI 字段（部分 feed） | `10.1038/xxx` |

##### 实现逻辑

在 RSSSource.fetch 方法中，为每个 entry 添加 DOI 提取函数调用：

**输入**：feedparser.FeedParserDict 对象（entry）

**处理流程**：

1. 检查 entry.id 字段
   - 若包含 `doi.org/` → 提取 DOI 部分
   - 若以 `doi:` 开头 → 移除前缀提取 DOI
   
2. 检查 entry.doi 字段（如果存在）
   - 直接返回值

3. 检查 entry.link 字段
   - 若包含 `doi.org/` → 提取 DOI 部分

4. 若以上均未找到 → 返回空字符串

**输出**：标准化的 DOI 字符串（不含 `https://doi.org/` 前缀）

##### DOI 提取规则表

| 输入格式 | 提取结果 |
|---------|---------|
| `https://doi.org/10.1038/s41586-024-12345-6` | `10.1038/s41586-024-12345-6` |
| `http://doi.org/10.1038/s41586-024-12345-6` | `10.1038/s41586-024-12345-6` |
| `doi:10.1038/s41586-024-12345-6` | `10.1038/s41586-024-12345-6` |
| `10.1038/s41586-024-12345-6` | `10.1038/s41586-024-12345-6` |
| 无 DOI 信息 | `''` |

##### Paper 对象实例化修改

修改后的实例化逻辑：

**原则**：
- 优先使用提取的 DOI
- 当 DOI 提取失败时，doi 字段保持空字符串
- link 字段始终保留原始链接

**字段赋值策略**：

| 字段 | 赋值来源 | 说明 |
|------|---------|------|
| doi | 提取函数返回值 | 若提取成功则为标准化 DOI，否则为空字符串 |
| link | entry.link | 始终保留原始链接 |

#### 2. 统一去重 ID 生成逻辑

##### 架构调整

**当前架构问题**：
- BaseSource.get_item_id：完整实现，支持配置
- ranking.get_item_id：简化实现，功能受限

**调整方案**：
- 保留 BaseSource.get_item_id 作为唯一实现
- ranking.get_item_id 改为调用 BaseSource.get_item_id
- 确保所有去重逻辑使用同一函数

##### 导入关系调整

**修改模块**：app/ranking.py

**调整内容**：

| 修改类型 | 具体操作 |
|---------|---------|
| 导入语句 | 新增 `from app.sources.base import BaseSource` |
| 函数实现 | get_item_id 改为调用 BaseSource 实例的方法 |
| 函数签名 | 保持不变，确保向后兼容 |

##### 实现方式

由于 BaseSource.get_item_id 是实例方法，需要创建临时实例或改为静态方法。

**方案选择**：将 BaseSource.get_item_id 提取为独立模块函数

**原因**：
- 该方法不依赖 BaseSource 的实例状态
- 提取后可被所有模块直接调用
- 避免循环依赖问题

##### 模块重构方案

**新增模块**：app/deduplication.py

**职责**：
- 提供唯一的去重 ID 生成函数
- 提供链接标准化和哈希函数
- 统一管理去重相关的所有逻辑

**函数列表**：

| 函数名 | 功能 | 输入 | 输出 |
|-------|------|------|------|
| get_item_id | 生成论文唯一标识符 | Paper 对象 | 标识符字符串 |
| normalize_link | 标准化链接 | 原始链接 | 标准化链接 |
| generate_link_hash | 生成链接哈希 | 链接 | SHA256 前16位 |

**调用关系**：

```
app/deduplication.py (新增)
    ↑
    ├─ app/sources/base.py (调用 get_item_id)
    ├─ app/ranking.py (调用 get_item_id)
    └─ 其他需要去重的模块
```

##### 迁移步骤

1. 创建 app/deduplication.py 模块
2. 将以下函数从 BaseSource 迁移到新模块：
   - _normalize_link → normalize_link
   - _generate_link_hash → generate_link_hash
   - get_item_id（保持签名不变）
3. BaseSource 中保留 get_item_id 方法作为代理，调用 deduplication.get_item_id
4. ranking.py 中的 get_item_id 改为调用 deduplication.get_item_id
5. 更新所有相关导入语句

#### 3. 去重逻辑一致性保证

##### ID 生成优先级

统一后的优先级顺序（与当前 BaseSource 保持一致）：

```
优先级 1: DOI 标识
  ├─ 清理前缀：https://doi.org/, http://doi.org/, doi:
  ├─ 格式：DOI:{cleaned_doi}
  └─ 示例：DOI:10.1038/s41586-024-12345-6

优先级 2: 链接标识（根据配置）
  ├─ 若 ENABLE_LINK_HASH_DEDUP=True
  │   ├─ 标准化链接
  │   ├─ 生成 SHA256 哈希前16位
  │   └─ 格式：LINK_HASH:{hash}
  └─ 若 ENABLE_LINK_HASH_DEDUP=False
      └─ 格式：LINK:{原始链接}

优先级 3: 标题标识
  ├─ 生成标题 SHA256 哈希前16位
  ├─ 若有来源：TITLE:{source}:{title_hash}
  └─ 若无来源：TITLE:{title_hash}
```

##### 向后兼容性保证

**已推送记录识别**：

历史数据库中的 sent_ids 可能包含以下格式：
- `DOI:xxx`
- `LINK:xxx`
- `TITLE:xxx` 或 `TITLE:source:xxx`

**兼容措施**：
- 保持 ID 格式前缀不变（DOI:, LINK:, TITLE:）
- 新增 LINK_HASH: 前缀仅在配置启用时生效
- Title 哈希化不影响新旧记录比对（新记录也生成哈希）

##### 配置项说明

| 配置项 | 类型 | 默认值 | 说明 |
|-------|------|--------|------|
| ENABLE_LINK_HASH_DEDUP | Boolean | True | 启用链接哈希去重 |

**行为差异**：

| 配置值 | Link 去重行为 | 适用场景 |
|--------|-------------|---------|
| True | 使用标准化后的链接哈希 | 同一文章链接存在多种变体 |
| False | 使用原始链接 | 链接格式统一，无需标准化 |

## 影响分析

### 功能影响

#### RSS 数据源

| 影响维度 | 变化内容 | 影响程度 |
|---------|---------|---------|
| DOI 覆盖率 | 从 0% 提升到约 60-80% | 高 |
| 跨源去重准确性 | 显著提升 | 高 |
| 数据完整性 | DOI 字段填充更完整 | 中 |

#### 去重逻辑

| 影响维度 | 变化内容 | 影响程度 |
|---------|---------|---------|
| 代码一致性 | 消除重复实现 | 高 |
| 维护成本 | 降低（单一实现点） | 高 |
| 功能统一性 | 全局使用相同去重规则 | 高 |

### 性能影响

#### DOI 提取

| 操作 | 时间复杂度 | 预估耗时 |
|------|-----------|---------|
| 字符串检查和替换 | O(n) | <1ms/条目 |
| 每个 RSS feed 15条 | O(15n) | <15ms/feed |
| 总计7个 feed | O(105n) | <105ms |

**结论**：性能影响可忽略

#### 去重逻辑统一

| 影响维度 | 变化 | 说明 |
|---------|------|------|
| 函数调用次数 | 无变化 | 仅改变调用目标，不增加调用次数 |
| 哈希计算 | 无新增 | 复用现有逻辑 |
| 内存占用 | 无变化 | ID 字符串长度不变 |

**结论**：性能无负面影响

### 数据影响

#### 已推送记录

**影响评估**：
- 历史 sent_ids 格式保持兼容
- DOI 提取增强不影响已有 LINK: 和 TITLE: 格式记录
- 不会导致历史文章重复推送

#### 新记录去重

**预期变化**：

| 场景 | 变化前 | 变化后 |
|------|--------|--------|
| RSS+PubMed 同一文章 | 可能重复推送 | 正确去重 |
| RSS feed entry.id 包含 DOI | 使用 LINK: 去重 | 使用 DOI: 去重 |
| 去重稳定性 | 中等 | 高 |

## 测试策略

### 单元测试

#### 测试模块：app/deduplication.py

| 测试用例 | 输入 | 期望输出 | 验证点 |
|---------|------|---------|--------|
| DOI 提取优先级 | Paper 有 doi 字段 | DOI:xxx | DOI 优先 |
| Link 哈希去重 | 配置启用，Paper 有 link | LINK_HASH:xxx | 哈希生成正确 |
| Link 原始去重 | 配置禁用，Paper 有 link | LINK:xxx | 原始链接使用 |
| Title 降级去重 | Paper 无 doi 和 link | TITLE:xxx | 降级逻辑正确 |
| 标准化链接一致性 | 不同格式相同文章链接 | 相同哈希 | 标准化有效 |

#### 测试模块：app/sources/rss.py

| 测试用例 | 输入 | 期望输出 | 验证点 |
|---------|------|---------|--------|
| entry.id 包含 doi.org | `https://doi.org/10.1038/xxx` | `10.1038/xxx` | DOI 提取正确 |
| entry.id 包含 doi: 前缀 | `doi:10.1038/xxx` | `10.1038/xxx` | 前缀清理正确 |
| entry.doi 字段存在 | entry.doi = `10.1038/xxx` | `10.1038/xxx` | 直接字段读取 |
| 无 DOI 信息 | 仅有 entry.link | 空字符串 | 降级处理正确 |
| Paper 对象 doi 字段 | 提取到 DOI | Paper.doi 非空 | 字段赋值正确 |

### 集成测试

#### 跨源去重测试

**测试场景**：模拟 RSS 和 PubMed 返回同一文章

| 步骤 | 操作 | 验证点 |
|------|------|--------|
| 1 | RSS 返回文章 A（提取 DOI 成功） | Paper.doi 非空 |
| 2 | PubMed 返回相同文章 A（含 DOI） | Paper.doi 相同 |
| 3 | 调用 deduplicate_papers | 仅保留一篇 |
| 4 | 检查 new_sent_ids | 仅包含一个 DOI:xxx |

#### 向后兼容测试

**测试场景**：使用历史 sent_ids 数据

| 步骤 | 操作 | 验证点 |
|------|------|--------|
| 1 | 加载包含旧格式 ID 的 sent_ids | 加载成功 |
| 2 | 抓取新论文（使用新逻辑） | 生成新格式 ID |
| 3 | 去重检查 | 新旧 ID 不冲突 |
| 4 | 历史文章再次出现 | 正确识别为已推送 |

### 回归测试

| 测试项 | 说明 | 通过标准 |
|-------|------|---------|
| 所有数据源抓取 | 运行完整抓取流程 | 无异常，数据正常 |
| 排序和选择 | TopK 选择逻辑 | 结果正确，无重复 |
| 推送记录保存 | sent_ids 保存和加载 | 数据一致 |
| 日志输出 | 去重相关日志 | 日志完整，格式正确 |

## 实施计划

### 开发阶段

| 阶段 | 任务 | 工作量估算 |
|------|------|-----------|
| 第一阶段 | 创建 app/deduplication.py 模块 | 1小时 |
| 第二阶段 | 迁移去重逻辑到新模块 | 1小时 |
| 第三阶段 | 修改 RSS 数据源 DOI 提取 | 1小时 |
| 第四阶段 | 更新 BaseSource 和 ranking 调用 | 0.5小时 |
| 第五阶段 | 编写单元测试 | 2小时 |

**总计**：约 5.5 小时

### 测试阶段

| 测试类型 | 工作量估算 |
|---------|-----------|
| 单元测试执行 | 0.5小时 |
| 集成测试执行 | 1小时 |
| 回归测试执行 | 1小时 |
| 问题修复 | 1小时（预留） |

**总计**：约 3.5 小时

### 上线阶段

| 步骤 | 说明 | 风险等级 |
|------|------|---------|
| 代码审查 | 评审设计和实现 | 低 |
| 灰度验证 | 小规模运行验证 | 低 |
| 全量上线 | 正式环境部署 | 低 |
| 监控观察 | 观察去重效果和日志 | 低 |

## 风险评估

### 技术风险

| 风险项 | 风险描述 | 可能性 | 影响程度 | 缓解措施 |
|-------|---------|--------|---------|---------|
| RSS feed 格式差异 | 不同期刊 feed 格式不一致 | 中 | 中 | 充分测试多个 feed，兼容多种格式 |
| DOI 提取误判 | 非 DOI 字符串被错误识别 | 低 | 低 | 严格的正则匹配和前缀检查 |
| 循环依赖 | 新模块引入导致循环依赖 | 低 | 高 | deduplication.py 设计为底层模块，不依赖其他业务模块 |

### 数据风险

| 风险项 | 风险描述 | 可能性 | 影响程度 | 缓解措施 |
|-------|---------|--------|---------|---------|
| 历史数据不兼容 | 新 ID 格式导致重复推送 | 低 | 高 | 保持 ID 格式前缀兼容，充分测试 |
| DOI 格式异常 | 提取到的 DOI 格式不标准 | 中 | 低 | 增加 DOI 格式验证和清理逻辑 |

### 运营风险

| 风险项 | 风险描述 | 可能性 | 影响程度 | 缓解措施 |
|-------|---------|--------|---------|---------|
| 去重过于严格 | 有效论文被误判为重复 | 低 | 中 | 详细日志记录，便于排查 |
| 去重不足 | 重复文章仍然被推送 | 中 | 低 | 灰度验证，监控推送内容 |

## 附录

### RSS Feed Entry 结构示例

典型的 Nature Plants RSS entry 结构：

| 字段 | 示例值 | 说明 |
|------|--------|------|
| entry.title | "Nitrogen fixation in legumes" | 文章标题 |
| entry.id | "https://doi.org/10.1038/s41477-024-12345-6" | 可能包含 DOI |
| entry.link | "https://www.nature.com/articles/s41477-024-12345-6" | 文章链接 |
| entry.published | "2024-12-20T10:00:00Z" | 发布时间 |
| entry.summary | "Abstract text..." | 摘要 |

### DOI 标准格式

| 组成部分 | 说明 | 示例 |
|---------|------|------|
| 前缀 | 固定为 10. | 10. |
| 注册机构代码 | 4位或更多数字 | 1038 |
| 后缀 | 标识符，可包含字母、数字、符号 | s41477-024-12345-6 |
| 完整格式 | prefix/suffix | 10.1038/s41477-024-12345-6 |

### 配置项参考

去重相关配置项：

| 配置项 | 类型 | 默认值 | 位置 | 说明 |
|-------|------|--------|------|------|
| ENABLE_LINK_HASH_DEDUP | Boolean | True | app/config.py | 启用链接哈希去重 |

### 相关文件清单

本次优化涉及的文件：

| 文件路径 | 修改类型 | 说明 |
|---------|---------|------|
| app/deduplication.py | 新增 | 统一去重逻辑模块 |
| app/sources/rss.py | 修改 | 增强 DOI 提取 |
| app/sources/base.py | 修改 | 调用 deduplication 模块 |
| app/ranking.py | 修改 | 调用 deduplication 模块 |
| tests/test_deduplication.py | 新增 | 单元测试 |
| tests/test_rss_doi_extraction.py | 新增 | RSS DOI 提取测试 |
