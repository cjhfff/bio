========================================
   生产环境代码更新检查清单
========================================

日期：__________
操作人：__________
版本：从 ________ 更新到 ________

----------------------------------------
第一步：更新前检查
----------------------------------------
□ 查看本次更新的内容和变更记录
□ 确认是否有破坏性变更
□ 确认是否需要新的环境变量
□ 记录当前版本号/提交哈希
□ 检查当前系统运行正常
□ 选择合适的更新时间（避开高峰期）
□ 通知相关人员

当前版本：__________
当前运行状态：□ 正常  □ 异常

----------------------------------------
第二步：备份（必须！）
----------------------------------------
□ 备份数据库文件
  路径：data/database/paper_push.db
  备份位置：__________
  
□ 备份配置文件（.env）
  备份位置：__________
  
□ 记录 Git 提交哈希
  提交哈希：__________
  
□ 验证备份文件完整性

备份目录：__________
备份时间：__________

----------------------------------------
第三步：停止服务
----------------------------------------
使用的方式：□ Docker  □ Systemd  □ Crontab  □ 后台进程

□ 停止定时任务/服务
□ 确认没有正在运行的任务
□ 记录停止时间：__________

----------------------------------------
第四步：更新代码
----------------------------------------
更新方式：□ Git Pull  □ SCP 上传  □ 手动替换

□ 拉取/上传最新代码
□ 检查代码变更
□ 解决冲突（如果有）

新版本：__________

----------------------------------------
第五步：更新依赖和配置
----------------------------------------
□ 更新 Python 依赖
  pip install -r requirements.txt --upgrade
  
□ 检查并更新 .env 配置文件
  新增配置项：__________
  
□ 运行数据库迁移（如需要）
  
□ 创建新目录（如需要）

----------------------------------------
第六步：测试验证
----------------------------------------
□ 测试代码能否正常加载
  python -c "from backend.api.main import app; print('OK')"
  
□ 测试数据源连接
  python -m backend test-sources
  
□ 手动运行一次完整流程
  python -m backend run --window-days 1 --top-k 5
  
□ 检查日志无错误
  tail -100 logs/paper_push_*.log
  
□ 验证功能正常
  □ 数据抓取  □ 评分  □ 报告生成  □ 推送

测试结果：□ 通过  □ 失败
失败原因：__________

----------------------------------------
第七步：重启服务
----------------------------------------
□ 启动服务/定时任务
□ 检查进程状态
□ 查看启动日志
□ 验证服务可访问
  curl http://127.0.0.1:8000/health

重启时间：__________
服务状态：□ 正常  □ 异常

----------------------------------------
第八步：监控验证
----------------------------------------
□ 实时监控日志（至少 1 小时）
  tail -f logs/paper_push_*.log
  
□ 等待下次定时任务执行
  预期执行时间：__________
  
□ 验证定时任务成功执行
  
□ 检查数据和报告是否正常生成
  
□ 持续监控 24 小时

第一次执行结果：□ 成功  □ 失败
24小时监控：□ 正常  □ 异常

----------------------------------------
遇到的问题和解决方案
----------------------------------------
问题1：
__________________________________________
__________________________________________

解决方案：
__________________________________________
__________________________________________

问题2：
__________________________________________
__________________________________________

解决方案：
__________________________________________
__________________________________________

----------------------------------------
回滚记录（如果需要）
----------------------------------------
□ 是否执行了回滚：□ 是  □ 否

回滚原因：__________

回滚步骤：
□ 停止服务
□ 恢复代码
□ 恢复数据库
□ 恢复配置
□ 重启服务
□ 验证回滚成功

回滚后状态：□ 正常  □ 异常

----------------------------------------
更新总结
----------------------------------------
更新是否成功：□ 是  □ 否

总耗时：__________

经验教训：
__________________________________________
__________________________________________
__________________________________________

下次改进建议：
__________________________________________
__________________________________________
__________________________________________

----------------------------------------
签字确认
----------------------------------------
操作人：__________   日期：__________

复核人：__________   日期：__________

========================================
详细指南请查看：docs/代码更新指南.md
========================================
