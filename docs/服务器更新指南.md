# 服务器代码更新指南

## 📋 更新前检查清单

### 1. 数据备份（**必须**）

在更新代码之前，**务必**备份以下数据：

#### 1.1 数据库备份
```bash
# 备份SQLite数据库
cp data/database/paper_push.db data/database/paper_push.db.backup.$(date +%Y%m%d_%H%M%S)

# 或者使用SQLite备份命令（更安全）
sqlite3 data/database/paper_push.db ".backup 'data/database/paper_push.db.backup.$(date +%Y%m%d_%H%M%S)'"
```

#### 1.2 配置文件备份
```bash
# 备份.env文件
cp .env .env.backup.$(date +%Y%m%d_%H%M%S)

# 备份关键词配置
cp data/keywords.json data/keywords.json.backup.$(date +%Y%m%d_%H%M%S) 2>/dev/null || echo "关键词文件不存在，跳过"
```

#### 1.3 日志文件（可选）
```bash
# 如果需要保留日志
mkdir -p backups/logs
cp -r logs/* backups/logs/ 2>/dev/null || echo "日志目录不存在，跳过"
```

### 2. 检查当前运行状态

```bash
# 检查是否有任务正在运行
curl http://localhost:8000/api/run/status

# 检查服务进程
ps aux | grep uvicorn
lsof -i:8000  # 检查端口占用
```

**⚠️ 重要**：如果有任务正在运行，请等待任务完成后再更新。

---

## 🔄 更新流程

### 方式一：使用自动化脚本（推荐）

```bash
# 1. 上传更新脚本到服务器
# 2. 赋予执行权限
chmod +x scripts/update_server.sh

# 3. 执行更新（会自动备份）
./scripts/update_server.sh
```

### 方式二：手动更新步骤

#### 步骤1：停止服务
```bash
# 查找并停止uvicorn进程
PID=$(lsof -t -i:8000)
if [ ! -z "$PID" ]; then
    kill -15 $PID  # 优雅关闭
    sleep 5
    # 如果还在运行，强制关闭
    if ps -p $PID > /dev/null; then
        kill -9 $PID
    fi
fi

# 或者使用pkill
pkill -f uvicorn
```

#### 步骤2：备份数据（见上方"数据备份"部分）

#### 步骤3：更新代码
```bash
# 如果使用Git
git pull origin main  # 或你的分支名

# 或者手动上传新代码文件
# scp -r backend/ frontend/ user@server:/path/to/project/
```

#### 步骤4：更新Python依赖
```bash
# 激活虚拟环境（如果使用）
source venv/bin/activate  # 或你的虚拟环境路径

# 更新依赖
pip install --upgrade pip
pip install -r requirements.txt

# 特别注意：如果requirements.txt有新增依赖，确保安装
```

#### 步骤5：数据库迁移（如果需要）
```bash
# 检查数据库结构是否需要更新
python3 -c "from backend.storage.db import init_db; init_db()"
```

#### 步骤6：验证代码
```bash
# 检查代码是否能正常导入（不启动服务）
python3 -c "import os; os.environ['DB_PATH']='data/database/paper_push.db'; from backend.api.main import app; print('✅ 代码验证通过')"
```

#### 步骤7：启动服务
```bash
# 方式1：直接启动（测试用）
python3 -m uvicorn backend.api.main:app --host 0.0.0.0 --port 8000

# 方式2：后台运行（生产环境）
nohup python3 -m uvicorn backend.api.main:app --host 0.0.0.0 --port 8000 > logs/api.log 2>&1 &

# 方式3：使用supervisor/systemd（推荐生产环境）
supervisorctl restart bio-backend
# 或
systemctl restart bio-backend
```

#### 步骤8：验证服务
```bash
# 等待5秒后检查健康状态
sleep 5
curl http://localhost:8000/health

# 检查日志
tail -f logs/api.log

# 检查进程
ps aux | grep uvicorn
```

---

## ⚠️ 重要注意事项

### 1. 配置文件保护

**不要覆盖以下文件**：
- `.env` - 包含敏感配置（API密钥、数据库路径等）
- `data/keywords.json` - 用户配置的关键词
- `data/database/paper_push.db` - 数据库文件

**更新策略**：
- 如果`.env.example`有更新，手动对比并更新`.env`
- 如果`data/keywords.json`结构变化，需要迁移脚本

### 2. 数据库兼容性

- SQLite数据库结构会自动迁移（通过`init_db()`）
- 但**数据不会丢失**（只添加新字段，不删除旧数据）
- 如果担心，先备份数据库

### 3. 定时任务

如果更新了定时任务相关代码：
```bash
# 检查定时任务状态
curl http://localhost:8000/api/config

# 如果需要重新配置定时任务，通过UI或API更新
```

### 4. 前端更新

如果更新了前端代码：
```bash
cd frontend
npm install  # 安装新依赖
npm run build  # 重新构建

# 如果使用Nginx，更新静态文件
cp -r dist/* /var/www/html/  # 或你的Nginx静态目录
```

### 5. 依赖版本冲突

如果遇到依赖冲突：
```bash
# 查看当前安装的版本
pip list | grep fastapi
pip list | grep uvicorn

# 如果requirements.txt指定了版本，确保匹配
pip install -r requirements.txt --force-reinstall
```

---

## 🔙 回滚方案

如果更新后出现问题，可以快速回滚：

### 1. 恢复代码
```bash
# 如果使用Git
git checkout <previous-commit-hash>
# 或
git reset --hard HEAD~1

# 如果手动备份，恢复文件
cp -r backup/backend/* backend/
cp -r backup/frontend/* frontend/
```

### 2. 恢复数据库
```bash
# 停止服务
pkill -f uvicorn

# 恢复数据库
cp data/database/paper_push.db.backup.YYYYMMDD_HHMMSS data/database/paper_push.db

# 重启服务
nohup python3 -m uvicorn backend.api.main:app --host 0.0.0.0 --port 8000 > logs/api.log 2>&1 &
```

### 3. 恢复配置
```bash
cp .env.backup.YYYYMMDD_HHMMSS .env
cp data/keywords.json.backup.YYYYMMDD_HHMMSS data/keywords.json
```

---

## 📊 更新后验证清单

更新完成后，请验证以下功能：

- [ ] 服务健康检查：`curl http://localhost:8000/health`
- [ ] 登录功能：访问登录页面，测试登录
- [ ] 配置加载：访问配置页面，检查配置是否正确加载
- [ ] 任务触发：在Dashboard点击"立即执行"，检查任务是否正常启动
- [ ] 数据查询：检查论文列表、运行记录是否正常显示
- [ ] 定时任务：如果配置了定时任务，检查状态和下次运行时间
- [ ] 日志输出：检查`logs/api.log`是否有错误信息

---

## 🚨 常见问题

### Q1: 更新后服务无法启动
**检查**：
1. 查看日志：`tail -50 logs/api.log`
2. 检查依赖：`pip list | grep -E "fastapi|uvicorn"`
3. 检查Python版本：`python3 --version`（需要3.9+）
4. 检查数据库路径：确保`data/database/`目录存在

### Q2: 更新后数据库错误
**解决**：
1. 恢复数据库备份
2. 运行`init_db()`初始化数据库结构
3. 检查数据库文件权限：`chmod 644 data/database/paper_push.db`

### Q3: 更新后配置丢失
**解决**：
1. 恢复`.env`备份
2. 恢复`data/keywords.json`备份
3. 通过UI重新配置

### Q4: 更新后前端无法访问
**检查**：
1. 前端是否重新构建：`cd frontend && npm run build`
2. Nginx配置是否正确
3. 静态文件路径是否正确

---

## 📝 更新日志模板

建议每次更新后记录：

```
更新日期：YYYY-MM-DD HH:MM
更新内容：
- [ ] 后端代码更新
- [ ] 前端代码更新
- [ ] 依赖更新
- [ ] 数据库结构变更
- [ ] 配置文件变更

备份文件：
- 数据库：paper_push.db.backup.YYYYMMDD_HHMMSS
- 配置：.env.backup.YYYYMMDD_HHMMSS

验证结果：
- [ ] 服务启动成功
- [ ] 功能测试通过
- [ ] 无错误日志

回滚方案：
- Git commit: <hash>
- 备份位置：/path/to/backups/
```

---

## 🔗 相关文档

- [部署指南](./服务器部署指南.md)
- [配置说明](./配置说明.md)
- [故障排查](./故障排查.md)
