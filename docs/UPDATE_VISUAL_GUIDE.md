# 代码更新图解指南

## 📖 目录
- [为什么需要代码更新](#为什么需要代码更新)
- [什么时候更新](#什么时候更新)
- [更新流程图](#更新流程图)
- [三种更新方式对比](#三种更新方式对比)
- [常见场景处理](#常见场景处理)

## 为什么需要代码更新

当服务器上的项目正在运行时，你可能需要更新代码来：
- 🐛 修复发现的bug
- ✨ 添加新功能
- 🔒 修复安全漏洞
- ⚡ 性能优化
- 📦 更新依赖包

## 什么时候更新

### 建议更新时机
- ⏰ 系统使用低峰期（如凌晨2-5点）
- 📅 周末或节假日
- 🔔 提前通知用户的维护窗口

### 避免更新时机
- ❌ 系统高峰期
- ❌ 重要任务运行时
- ❌ 无备份的情况下

## 更新流程图

```
开始
  ↓
[1. 更新前检查]
  - 检查服务状态 ✓
  - 查看当前版本 ✓
  ↓
[2. 备份数据]
  - 备份数据库 ✓
  - 备份配置文件 ✓
  - 备份当前代码 ✓
  ↓
[3. 停止服务]
  - 停止Docker/进程 ✓
  - 禁用定时任务 ✓
  ↓
[4. 更新代码]
  - 拉取最新代码 ✓
  - 更新依赖 ✓
  ↓
[5. 数据迁移]
  - 运行迁移脚本 ✓
  - 更新配置 ✓
  ↓
[6. 测试验证]
  - 运行测试 ✓
  - 检查配置 ✓
  ↓
[7. 重启服务]
  - 启动服务 ✓
  - 启用定时任务 ✓
  ↓
[8. 验证运行]
  - 检查日志 ✓
  - 测试接口 ✓
  - 监控15分钟 ✓
  ↓
完成
```

## 三种更新方式对比

### 方式1: 自动化脚本（最推荐⭐⭐⭐）

**适用场景**: 大多数更新场景

**优点**:
- ✅ 自动备份
- ✅ 自动化执行，减少人为错误
- ✅ 提供回滚信息
- ✅ 适合非技术人员

**使用方法**:
```bash
cd /root/bio_monitor
bash scripts/update_server.sh
```

**时间**: 约5-15分钟

### 方式2: 手动更新（推荐⭐⭐）

**适用场景**: 需要精确控制每个步骤时

**优点**:
- ✅ 完全控制更新过程
- ✅ 可以针对性处理问题
- ✅ 适合有特殊需求的更新

**步骤**: 参考 [UPDATE_GUIDE.md](./UPDATE_GUIDE.md)

**时间**: 约15-30分钟

### 方式3: 零停机更新（高级⭐）

**适用场景**: 生产环境，不能停机

**优点**:
- ✅ 用户无感知
- ✅ 可以快速切换新旧版本
- ✅ 适合关键业务

**方法**: 使用Docker蓝绿部署或tmux

**时间**: 约20-40分钟

## 常见场景处理

### 场景1: 只修改了Python代码
```bash
# 快速更新（不需要重装依赖）
git pull origin main
docker-compose restart
# 或
kill <PID> && python -m backend run
```
⏱️ 耗时：2-3分钟

### 场景2: 更新了依赖包
```bash
# 需要重装依赖
git pull origin main
pip install -r requirements.txt --upgrade
docker-compose restart
```
⏱️ 耗时：5-10分钟

### 场景3: 数据库结构变更
```bash
# 需要备份并运行迁移
cp data/database/paper_push.db backup/
git pull origin main
python scripts/migrate_database.py
docker-compose restart
```
⏱️ 耗时：10-20分钟

### 场景4: 前后端都更新
```bash
# 完整更新流程
bash scripts/update_server.sh
```
⏱️ 耗时：15-30分钟

### 场景5: 紧急热修复
```bash
# 1. 先备份
cp data/database/paper_push.db backup/$(date +%Y%m%d_%H%M%S).db

# 2. 快速更新
git pull origin hotfix-branch
docker-compose restart

# 3. 立即验证
tail -f logs/api.log
```
⏱️ 耗时：3-5分钟

## 更新检查清单（打印版）

```
□ 更新前
  □ 已连接服务器
  □ 已备份数据库
  □ 已备份配置文件
  □ 已记录当前版本

□ 更新中
  □ 已停止服务
  □ 已拉取代码
  □ 已更新依赖
  □ 已运行迁移

□ 更新后
  □ 已重启服务
  □ 已检查日志
  □ 已测试功能
  □ 已监控15分钟

□ 如有问题
  □ 立即回滚
  □ 查看日志
  □ 恢复备份
```

## 更新后验证清单

| 检查项 | 命令 | 预期结果 |
|--------|------|----------|
| 进程运行 | `ps aux \| grep python` | 看到进程运行 |
| 端口监听 | `netstat -tulpn \| grep 8000` | 端口在监听 |
| API响应 | `curl http://localhost:8000/api/health` | 返回200 |
| 日志正常 | `tail -f logs/api.log` | 无ERROR |
| 数据库访问 | `sqlite3 data/database/paper_push.db ".tables"` | 显示表列表 |

## 回滚决策树

```
更新后是否正常？
  ├─ 是 → 观察15分钟 → 更新完成 ✓
  │
  └─ 否 → 是否严重问题？
          ├─ 是 → 立即回滚
          │       └─ git reset + 恢复备份
          │
          └─ 否 → 尝试修复（5分钟）
                  ├─ 修复成功 → 继续运行 ✓
                  │
                  └─ 修复失败 → 回滚
                              └─ git reset + 恢复备份
```

## 应急联系

**出现问题时的操作顺序**:
1. 🔴 **立即**: 执行回滚操作
2. 📝 **记录**: 保存错误日志
3. 🔍 **分析**: 查看 UPDATE_GUIDE.md 常见问题章节
4. 💬 **求助**: 如无法解决，寻求技术支持

## 相关文档链接

- 📖 [完整更新指南](./UPDATE_GUIDE.md) - 详细步骤和故障排除
- ✅ [快速检查清单](./UPDATE_CHECKLIST.md) - 更新时对照使用
- 🚀 [部署指南](./deploy.md) - 初次部署参考
- 🔧 [定时任务设置](./README_定时任务设置.md) - 定时任务配置

## 小贴士 💡

1. **首次更新**: 建议在测试环境先练习一次
2. **定期更新**: 建议每月检查一次是否有更新
3. **保留备份**: 至少保留最近7天的备份
4. **记录日志**: 每次更新记录时间、版本、结果
5. **非高峰期**: 尽量选择系统使用低峰期更新
6. **监控告警**: 配置监控系统，更新后自动检测异常

---

**问题反馈**: 如果在更新过程中遇到本文档未涵盖的问题，请提交Issue或联系管理员。
