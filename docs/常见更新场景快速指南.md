# 常见更新场景快速指南

本文档提供常见更新场景的快速操作步骤。详细说明请参考 [代码更新指南](./代码更新指南.md)。

---

## 🚨 紧急提醒

**每次更新前必须做的三件事：**
1. ✅ 备份数据库：`cp data/database/paper_push.db /backup/`
2. ✅ 记录当前版本：`git log -1 > /tmp/current_version.txt`
3. ✅ 停止运行的服务

---

## 场景1：小修小改（Bug修复、配置调整）

**适用于**：修复小Bug、调整配置参数、更新文档等

### 快速步骤

```bash
# 1. 备份
BACKUP_DIR=/root/bio_backups/$(date +%Y%m%d_%H%M%S)
mkdir -p $BACKUP_DIR
cp data/database/paper_push.db $BACKUP_DIR/
cp .env $BACKUP_DIR/
git log -1 > $BACKUP_DIR/version.txt

# 2. 停止服务（选择一种）
docker-compose down                    # Docker
sudo systemctl stop paper-push.timer   # Systemd
crontab -r                             # Crontab

# 3. 更新代码
git pull origin main

# 4. 快速测试
python -c "from backend.api.main import app; print('✓ OK')"

# 5. 重启服务（选择一种）
docker-compose up -d                   # Docker
sudo systemctl start paper-push.timer  # Systemd
crontab /tmp/crontab_backup.txt        # Crontab

# 6. 查看日志
tail -f logs/paper_push_*.log
```

**预计时间**：5-10分钟

---

## 场景2：功能更新（新增数据源、优化算法）

**适用于**：新增功能、优化现有功能等

### 快速步骤

```bash
# 1. 备份（同场景1）
BACKUP_DIR=/root/bio_backups/$(date +%Y%m%d_%H%M%S)
mkdir -p $BACKUP_DIR
cp data/database/paper_push.db $BACKUP_DIR/
cp .env $BACKUP_DIR/
git log -1 > $BACKUP_DIR/version.txt

# 2. 停止服务
docker-compose down  # 或其他方式

# 3. 更新代码
git pull origin main

# 4. 更新依赖（重要！）
pip install -r requirements.txt --upgrade

# 5. 检查新配置项
diff .env.example .env
# 如果有新配置，添加到 .env

# 6. 完整测试
python -m backend test-sources
python -m backend run --window-days 1 --top-k 5

# 7. 检查测试结果
tail -100 logs/paper_push_*.log

# 8. 重启服务
docker-compose up -d  # 或其他方式

# 9. 持续监控（至少1小时）
tail -f logs/paper_push_*.log
```

**预计时间**：15-30分钟

---

## 场景3：重大更新（数据库结构变更、API变更）

**适用于**：数据库schema变更、API重大变更、架构调整等

### 快速步骤

```bash
# 1. 完整备份
BACKUP_DIR=/root/bio_backups/$(date +%Y%m%d_%H%M%S)
mkdir -p $BACKUP_DIR
cp data/database/paper_push.db $BACKUP_DIR/
cp .env $BACKUP_DIR/
git log -1 > $BACKUP_DIR/version.txt
git diff > $BACKUP_DIR/local_changes.diff

# 打包整个项目
cd .. && tar -czf $BACKUP_DIR/bio_full_backup.tar.gz bio/ \
  --exclude=bio/data --exclude=bio/logs --exclude=bio/__pycache__

# 2. 导出数据库（额外保护）
sqlite3 data/database/paper_push.db ".dump" > $BACKUP_DIR/database_dump.sql

# 3. 停止服务
docker-compose down  # 或其他方式

# 4. 更新代码
git pull origin main

# 5. 更新依赖
pip install -r requirements.txt --upgrade

# 6. 检查配置变更
diff .env.example .env
# 添加新配置项到 .env

# 7. 运行数据库迁移（如果有迁移脚本）
python scripts/migrate_database.py

# 8. 完整测试
python -m backend test-sources
python -m backend run --window-days 1 --top-k 5

# 9. 测试Web界面（如果有）
cd frontend && npm install && npm run build

# 10. 重启服务
docker-compose up -d  # 或其他方式

# 11. 深度验证
# - 检查日志
tail -100 logs/paper_push_*.log
# - 访问 Web 界面
# - 等待定时任务执行

# 12. 持续监控（至少24小时）
tail -f logs/paper_push_*.log
```

**预计时间**：30-60分钟

---

## 场景4：紧急回滚

**适用于**：更新后发现严重问题，需要立即回滚

### 快速步骤

```bash
# 1. 立即停止服务
docker-compose down  # 或其他方式

# 2. 找到备份目录
ls -lt /root/bio_backups/
# 选择最新的备份，例如：20240126_103000

# 3. 恢复数据库
cp /root/bio_backups/20240126_103000/paper_push.db data/database/

# 4. 恢复配置
cp /root/bio_backups/20240126_103000/.env ./

# 5. 回滚代码
# 方式1：Git回滚
PREVIOUS_COMMIT=$(cat /root/bio_backups/20240126_103000/version.txt | head -1 | awk '{print $2}')
git reset --hard $PREVIOUS_COMMIT

# 方式2：从备份恢复
cd .. && tar -xzf /root/bio_backups/20240126_103000/bio_full_backup.tar.gz

# 6. 重启服务
docker-compose up -d  # 或其他方式

# 7. 验证回滚成功
git log -1
python -m backend run --window-days 1 --top-k 5
tail -100 logs/paper_push_*.log
```

**预计时间**：5-10分钟

---

## 场景5：只更新配置文件

**适用于**：只需要修改配置，不需要更新代码

### 快速步骤

```bash
# 1. 备份配置
cp .env .env.backup.$(date +%Y%m%d_%H%M%S)

# 2. 修改配置
nano .env
# 或者
vi .env

# 3. 验证配置
python -c "from backend.core.config import Config; print('✓ Config loaded')"

# 4. 如果服务在运行，重启服务
docker-compose restart backend  # Docker
sudo systemctl restart paper-push.timer  # Systemd

# 5. 查看日志确认
tail -f logs/paper_push_*.log
```

**预计时间**：2-5分钟

---

## 场景6：只更新前端

**适用于**：只修改了前端代码，后端不变

### 快速步骤

```bash
# 1. 进入前端目录
cd frontend

# 2. 拉取最新代码（如果使用Git）
git pull origin main

# 3. 安装新依赖（如果有）
npm install

# 4. 构建前端
npm run build

# 5. 重启前端服务（如果使用Docker）
cd ../docker
docker-compose restart frontend

# 6. 验证
# 访问 http://server-ip:3000
# 检查浏览器控制台无错误
```

**预计时间**：5-10分钟

---

## 场景7：定时任务时间调整

**适用于**：只需要修改定时任务执行时间

### 使用 Systemd

```bash
# 1. 编辑定时器配置
sudo nano /etc/systemd/system/paper-push.timer

# 修改 OnCalendar 行，例如：
# OnCalendar=*-*-* 09:00:00  # 改为每天9点

# 2. 重新加载配置
sudo systemctl daemon-reload

# 3. 重启定时器
sudo systemctl restart paper-push.timer

# 4. 验证新时间
systemctl list-timers paper-push.timer
```

### 使用 Crontab

```bash
# 1. 编辑 crontab
crontab -e

# 修改执行时间，例如：
# 0 9 * * * cd /path/to/bio && python -m backend run
# 改为每天9点执行

# 2. 保存退出（Ctrl+O, Enter, Ctrl+X）

# 3. 验证
crontab -l
```

**预计时间**：2-3分钟

---

## 常用命令速查

### 检查服务状态

```bash
# Docker
docker-compose ps

# Systemd
sudo systemctl status paper-push.timer

# Crontab
crontab -l

# 进程
ps aux | grep "python.*backend"
```

### 查看日志

```bash
# 主日志
tail -f logs/paper_push_*.log

# API 日志
tail -f logs/api.log

# Docker 日志
docker-compose logs -f backend

# Systemd 日志
journalctl -u paper-push.service -f
```

### 手动运行测试

```bash
# 测试数据源
python -m backend test-sources

# 运行一次完整流程（少量数据）
python -m backend run --window-days 1 --top-k 5

# 查看数据库
sqlite3 data/database/paper_push.db "SELECT COUNT(*) FROM papers;"
```

---

## 📱 快速决策树

```
需要更新代码？
│
├─ 是 → 是否有数据库变更？
│      ├─ 是 → 使用场景3（重大更新）
│      └─ 否 → 是否有新依赖？
│             ├─ 是 → 使用场景2（功能更新）
│             └─ 否 → 使用场景1（小修小改）
│
├─ 否 → 只改配置？
│      ├─ 是 → 使用场景5（只更新配置）
│      └─ 否 → 只改前端？
│             ├─ 是 → 使用场景6（只更新前端）
│             └─ 否 → 只改定时任务时间？
│                    └─ 是 → 使用场景7（定时任务调整）
│
└─ 出问题了？→ 使用场景4（紧急回滚）
```

---

## ⚠️ 注意事项

1. **始终先备份**：无论多小的改动，都要备份数据库和配置
2. **避开高峰期**：定时任务执行期间不要更新
3. **充分测试**：更新后至少手动运行一次完整流程
4. **持续观察**：更新后至少观察24小时
5. **做好记录**：记录每次更新的内容和遇到的问题

---

## 📚 详细文档

- [完整的代码更新指南](./代码更新指南.md)
- [初次部署指南](./服务器部署指南.md)
- [部署调整清单](./部署调整清单.md)

---

**记住：安全>速度，备份>一切！**
