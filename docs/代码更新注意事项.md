# 服务器代码更新注意事项 - 快速参考

## 📌 问题：这个项目现在在服务上运行，如果我要更新代码，需要注意什么吗？

## ✅ 简要回答

是的，更新运行中的代码需要特别注意。我们已经为您准备了完整的更新指南和自动化脚本。

## 🚀 最快速的方法

```bash
# 连接服务器
ssh root@服务器IP

# 进入项目目录
cd /root/bio_monitor  # 或您的项目路径

# 运行自动更新脚本
bash scripts/update_server.sh
```

脚本会自动处理：
- ✅ 备份数据库和配置
- ✅ 停止服务
- ✅ 更新代码
- ✅ 更新依赖
- ✅ 重启服务
- ✅ 验证状态

## ⚠️ 核心注意事项

### 1. 更新前必须做
- **备份数据库** - 防止数据丢失
- **备份配置文件** (.env) - 防止配置丢失
- **记录当前版本** - 方便回滚
- **选择低峰期** - 减少影响

### 2. 更新时必须注意
- **停止正在运行的服务** - 避免冲突
- **检查依赖更新** - requirements.txt变更时重新安装
- **检查配置变更** - .env.example中的新配置项
- **运行数据库迁移** - 如果有结构变更

### 3. 更新后必须验证
- **检查服务状态** - 确认进程正在运行
- **查看日志** - 确认无错误
- **测试功能** - 运行测试命令
- **监控15分钟** - 确保稳定运行

### 4. 如果出问题
- **立即回滚** - 恢复到旧版本
- **恢复备份** - 还原数据库和配置
- **查看日志** - 定位问题原因

## 📚 详细文档索引

根据您的需求选择合适的文档：

### 🎯 我想快速上手
→ **[UPDATE_CHECKLIST.md](./UPDATE_CHECKLIST.md)** - 检查清单，对照操作

### 🎓 我想了解完整流程
→ **[UPDATE_GUIDE.md](./UPDATE_GUIDE.md)** - 完整指南，包含所有细节

### 📊 我想看图解说明
→ **[UPDATE_VISUAL_GUIDE.md](./UPDATE_VISUAL_GUIDE.md)** - 流程图和场景说明

### 🛠️ 我想自动化操作
→ **scripts/update_server.sh** - 自动化更新脚本

### 🚀 我想了解初次部署
→ **[deploy.md](./deploy.md)** - 部署指南

## 💡 最佳实践建议

1. **定期更新** - 每月检查一次更新
2. **测试环境验证** - 先在测试环境验证再生产更新
3. **非高峰期更新** - 凌晨或周末进行
4. **保留足够备份** - 至少保留7天
5. **记录更新日志** - 记录每次更新的时间、版本、结果
6. **使用自动化脚本** - 减少人为错误

## 🔍 常见场景快速指南

### 场景1: 只改了代码
```bash
git pull origin main
docker-compose restart
```
⏱️ 2-3分钟

### 场景2: 更新了依赖
```bash
git pull origin main
pip install -r requirements.txt --upgrade
docker-compose restart
```
⏱️ 5-10分钟

### 场景3: 数据库结构变了
```bash
# 先备份！
cp data/database/paper_push.db backup/$(date +%Y%m%d).db
git pull origin main
python scripts/migrate_database.py
docker-compose restart
```
⏱️ 10-20分钟

### 场景4: 完整更新（推荐）
```bash
bash scripts/update_server.sh
```
⏱️ 15-30分钟

## 🆘 紧急回滚

如果更新后出问题，立即执行：

```bash
# 1. 停止服务
docker-compose down  # 或 kill <PID>

# 2. 回滚代码
git reset --hard <旧版本commit>

# 3. 恢复数据库
cp /root/backups/最新备份/paper_push.db.backup data/database/paper_push.db

# 4. 恢复配置
cp /root/backups/最新备份/.env.backup .env

# 5. 重启服务
docker-compose up -d
```

## 📞 获取帮助

- 遇到问题？查看 [UPDATE_GUIDE.md](./UPDATE_GUIDE.md) 的"常见问题处理"章节
- 需要详细步骤？查看 [UPDATE_GUIDE.md](./UPDATE_GUIDE.md) 的完整流程
- 想看可视化说明？查看 [UPDATE_VISUAL_GUIDE.md](./UPDATE_VISUAL_GUIDE.md)
- 需要快速检查清单？查看 [UPDATE_CHECKLIST.md](./UPDATE_CHECKLIST.md)

## ✨ 总结

**更新代码的关键是：**
1. ⚠️ **更新前备份** - 数据库、配置、版本信息
2. 🛑 **停止服务** - 避免冲突
3. 🔄 **更新代码和依赖** - git pull + pip install
4. ✅ **验证和监控** - 确保正常运行
5. 🔙 **准备回滚** - 出问题立即恢复

**推荐使用自动化脚本来处理所有这些步骤！**

```bash
bash scripts/update_server.sh
```

---

📝 **本文档创建于**: 2024年
🔄 **最后更新**: 2024年
📧 **问题反馈**: 请提交Issue或联系项目管理员
