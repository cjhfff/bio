# 服务器部署指南

本文档说明如何将代码从 Windows 开发环境部署到 Linux 服务器。

## 一、部署前检查清单

### 1. 代码调整项

#### ✅ 路径配置（已自动处理）
- **数据库路径**：`data/paper_push.db` - 使用相对路径，自动创建目录
- **日志路径**：`logs/` - 自动创建目录
- **报告路径**：`reports/` - 需要手动创建或代码中确保存在

#### ⚠️ 需要调整的配置

**1. 代理设置（重要）**
- **当前状态**：代码强制清除所有代理设置（`proxies={'http': None, 'https': None}`）
- **服务器环境**：如果服务器需要代理访问外网，需要修改代码
- **调整位置**：
  - `app/cli.py` (第6-11行)：清除环境变量中的代理
  - `app/sources/*.py`：所有 `proxies={'http': None, 'https': None}` 的地方
  - `app/push/pushplus.py`：推送时的代理设置

**2. 文件路径分隔符**
- **当前状态**：代码使用 `Path` 对象，自动处理 Windows/Linux 路径差异
- **无需调整**：Python 的 `pathlib.Path` 会自动适配

**3. 编码问题**
- **当前状态**：日志和文件操作已使用 `encoding='utf-8'`
- **Linux 环境**：确保系统 locale 支持 UTF-8

### 2. 环境变量配置

创建 `.env` 文件（在项目根目录）：

```bash
# DeepSeek API 配置（必需）
DEEPSEEK_API_KEY=sk-xxx,sk-yyy  # 多个密钥用逗号分隔

# PubMed 配置（必需）
PUBMED_EMAIL=your-email@example.com

# 推送配置（可选）
PUSHPLUS_TOKENS=token1,token2  # PushPlus token，多个用逗号分隔
EMAIL_SMTP_HOST=smtp.example.com
EMAIL_SMTP_PORT=587
EMAIL_SMTP_USER=your-email@example.com
EMAIL_SMTP_PASSWORD=your-password
EMAIL_TO=recipient@example.com
WECOM_WEBHOOK_URL=https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxx

# 数据库路径（可选，默认 data/paper_push.db）
DB_PATH=data/paper_push.db

# 日志配置（可选）
LOG_FILE=paper_push.log
LOG_LEVEL=INFO

# 检索窗口（可选，默认1天）
DEFAULT_WINDOW_DAYS=1
EUROPEPMC_WINDOW_DAYS=1

# 快速筛选阈值（可选，默认50）
QUICK_FILTER_THRESHOLD=50

# API 超时和重试（可选）
API_TIMEOUT=600
API_MAX_RETRIES=3
API_RETRY_BASE_DELAY=10
API_RETRY_MAX_DELAY=60
```

### 3. 目录结构

确保以下目录存在（代码会自动创建，但建议提前创建）：

```bash
mkdir -p data      # 数据库文件
mkdir -p logs      # 日志文件
mkdir -p reports   # 生成的报告
```

## 二、部署步骤

### 1. 上传代码到服务器

```bash
# 方式1：使用 git
git clone <repository-url>
cd bio

# 方式2：使用 scp
scp -r bio/ user@server:/path/to/bio
```

### 2. 安装 Python 依赖

```bash
# 确保 Python 3.8+ 已安装
python3 --version

# 创建虚拟环境（推荐）
python3 -m venv venv
source venv/bin/activate  # Linux
# 或
venv\Scripts\activate  # Windows

# 安装依赖
pip install -r requirements.txt
```

### 3. 配置环境变量

```bash
# 复制示例配置
cp .env.example .env  # 如果有示例文件

# 编辑配置
nano .env  # 或使用 vim/vi
```

### 4. 初始化数据库

```bash
# 运行一次以初始化数据库
python3 -m app run
```

### 5. 测试运行

```bash
# 测试所有数据源
python3 -m app test-sources

# 运行一次完整流程
python3 -m app run
```

## 三、定时任务配置

### Linux 使用 Crontab

```bash
# 编辑 crontab
crontab -e

# 添加以下行（每天早上 8:30 运行）
30 8 * * * cd /path/to/bio && /path/to/venv/bin/python -m app run >> /path/to/bio/logs/cron.log 2>&1
```

### Linux 使用 Systemd（推荐）

创建服务文件 `/etc/systemd/system/paper-push.service`：

```ini
[Unit]
Description=Paper Push Daily Task
After=network.target

[Service]
Type=oneshot
User=your-user
WorkingDirectory=/path/to/bio
Environment="PATH=/path/to/bio/venv/bin:/usr/bin"
ExecStart=/path/to/bio/venv/bin/python -m app run
StandardOutput=append:/path/to/bio/logs/systemd.log
StandardError=append:/path/to/bio/logs/systemd.log

[Install]
WantedBy=multi-user.target
```

创建定时器文件 `/etc/systemd/system/paper-push.timer`：

```ini
[Unit]
Description=Run Paper Push Daily at 8:30 AM
Requires=paper-push.service

[Timer]
OnCalendar=*-*-* 08:30:00
Persistent=true

[Install]
WantedBy=timers.target
```

启用定时器：

```bash
sudo systemctl daemon-reload
sudo systemctl enable paper-push.timer
sudo systemctl start paper-push.timer
sudo systemctl status paper-push.timer
```

## 四、代理配置（如果需要）

### 方案1：修改代码支持代理（推荐）

修改 `app/config.py`，添加代理配置：

```python
# 代理配置
HTTP_PROXY = os.getenv("HTTP_PROXY", "")
HTTPS_PROXY = os.getenv("HTTPS_PROXY", "")
USE_PROXY = os.getenv("USE_PROXY", "false").lower() == "true"
```

修改 `app/cli.py`：

```python
# 在导入网络库之前
if Config.USE_PROXY:
    if Config.HTTP_PROXY:
        os.environ['http_proxy'] = Config.HTTP_PROXY
    if Config.HTTPS_PROXY:
        os.environ['https_proxy'] = Config.HTTPS_PROXY
else:
    # 清除代理设置（原有逻辑）
    os.environ.pop('http_proxy', None)
    # ... 其他清除逻辑
```

修改所有 `app/sources/*.py` 和 `app/push/*.py`：

```python
# 替换
proxies={'http': None, 'https': None}

# 为
if Config.USE_PROXY and Config.HTTP_PROXY:
    proxies = {
        'http': Config.HTTP_PROXY,
        'https': Config.HTTPS_PROXY or Config.HTTP_PROXY
    }
else:
    proxies = {'http': None, 'https': None}
```

然后在 `.env` 中添加：

```bash
USE_PROXY=true
HTTP_PROXY=http://proxy.example.com:8080
HTTPS_PROXY=http://proxy.example.com:8080
```

### 方案2：使用系统代理

如果服务器已配置系统代理，可以移除代码中的 `proxies={'http': None, 'https': None}` 设置，让 requests 使用系统代理。

## 五、文件权限

确保以下目录和文件有正确的权限：

```bash
# 设置目录权限
chmod 755 data logs reports

# 设置数据库文件权限（如果已存在）
chmod 644 data/paper_push.db

# 确保运行用户有写入权限
chown -R your-user:your-group data logs reports
```

## 六、监控和日志

### 查看日志

```bash
# 查看最新日志
tail -f logs/paper_push_*.log

# 查看系统日志（如果使用 systemd）
journalctl -u paper-push.service -f
```

### 检查运行状态

```bash
# 检查定时任务状态（systemd）
sudo systemctl status paper-push.timer

# 检查定时任务状态（crontab）
grep paper-push /var/log/cron  # 或查看 /var/log/syslog
```

## 七、常见问题

### 1. 数据库锁定错误

**问题**：`database is locked`

**解决**：
- 确保只有一个进程在访问数据库
- 检查是否有未关闭的数据库连接
- 代码已启用 WAL 模式，应该能处理并发访问

### 2. 网络连接超时

**问题**：API 调用超时

**解决**：
- 检查网络连接
- 如果使用代理，确保代理配置正确
- 增加 `API_TIMEOUT` 环境变量值

### 3. 编码错误

**问题**：日志或报告中的中文乱码

**解决**：
```bash
# 设置系统 locale
export LANG=zh_CN.UTF-8
export LC_ALL=zh_CN.UTF-8

# 或在 crontab/systemd 中设置
```

### 4. 权限错误

**问题**：无法创建文件或目录

**解决**：
```bash
# 检查目录权限
ls -la data logs reports

# 修复权限
chmod 755 data logs reports
chown -R your-user:your-group data logs reports
```

### 5. 依赖缺失

**问题**：`ModuleNotFoundError`

**解决**：
```bash
# 确保在虚拟环境中
source venv/bin/activate

# 重新安装依赖
pip install -r requirements.txt
```

## 八、性能优化建议

### 1. 数据库优化

```bash
# 定期清理旧数据（可选）
# 创建 scripts/cleanup_old_data.py
```

### 2. 日志轮转

配置 logrotate（`/etc/logrotate.d/paper-push`）：

```
/path/to/bio/logs/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 0644 your-user your-group
}
```

### 3. 资源限制

如果使用 systemd，可以在服务文件中添加资源限制：

```ini
[Service]
MemoryLimit=2G
CPUQuota=50%
```

## 九、安全检查

1. **保护 `.env` 文件**：
   ```bash
   chmod 600 .env
   ```

2. **不要将 `.env` 提交到版本控制**：
   ```bash
   echo ".env" >> .gitignore
   ```

3. **定期更新依赖**：
   ```bash
   pip list --outdated
   pip install --upgrade <package>
   ```

## 十、回滚方案

如果部署后出现问题：

1. **恢复代码**：
   ```bash
   git checkout <previous-commit>
   # 或
   scp -r backup/bio/* /path/to/bio/
   ```

2. **恢复数据库**（如果有备份）：
   ```bash
   cp backup/paper_push.db data/paper_push.db
   ```

3. **检查日志**：
   ```bash
   tail -100 logs/paper_push_*.log
   ```

---

## 快速部署脚本

创建 `scripts/deploy_server.sh`：

```bash
#!/bin/bash
set -e

PROJECT_DIR="/path/to/bio"
VENV_DIR="$PROJECT_DIR/venv"

echo "开始部署..."

# 1. 进入项目目录
cd "$PROJECT_DIR"

# 2. 创建虚拟环境（如果不存在）
if [ ! -d "$VENV_DIR" ]; then
    python3 -m venv "$VENV_DIR"
fi

# 3. 激活虚拟环境并安装依赖
source "$VENV_DIR/bin/activate"
pip install -r requirements.txt

# 4. 创建必要目录
mkdir -p data logs reports

# 5. 初始化数据库
python -m app run --help  # 触发数据库初始化

echo "部署完成！"
echo "请确保已配置 .env 文件"
echo "运行测试: python -m app test-sources"
```

使用方法：

```bash
chmod +x scripts/deploy_server.sh
./scripts/deploy_server.sh
```

