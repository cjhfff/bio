# 关于生产环境代码更新的注意事项

您好！针对您提出的问题"这个项目现在在服务上运行，如果我要更新代码，需要注意什么吗"，我已经为您准备了详细的文档和工具。

## 📚 快速导航

### 1. 主要文档

- **[生产环境代码更新指南](./生产环境代码更新指南.md)** - 完整详细的更新指南（推荐阅读）
- **[代码更新速查表](./代码更新速查表.md)** - 常用命令快速参考
- [服务器部署指南](./服务器部署指南.md) - 首次部署指南
- [部署调整清单](./部署调整清单.md) - 配置检查清单

### 2. 实用工具

- **`scripts/check_update_safety.sh`** - 更新前安全检查脚本（强烈推荐使用）

## 🎯 核心要点总结

### 更新前必做的三件事：

1. **备份数据**
   ```bash
   cp data/paper_push.db data/paper_push.db.backup.$(date +%Y%m%d_%H%M%S)
   cp .env .env.backup.$(date +%Y%m%d_%H%M%S)
   ```

2. **停止服务**
   ```bash
   # 如果使用 systemd
   sudo systemctl stop paper-push.timer
   
   # 如果使用 crontab，避开定时任务运行时间
   ```

3. **运行安全检查**
   ```bash
   ./scripts/check_update_safety.sh
   ```

### 更新代码的基本步骤：

```bash
# 1. 进入项目目录
cd /path/to/bio

# 2. 拉取最新代码
git pull origin main

# 3. 如果依赖有更新，重新安装
pip install -r requirements.txt

# 4. 测试验证
python -m backend test-sources

# 5. 重启服务
sudo systemctl start paper-push.timer

# 6. 监控日志
tail -f logs/paper_push_*.log
```

### 需要特别注意的事项：

#### ❌ 禁止操作
- **不要删除** `data/` 目录（包含数据库）
- **不要删除** `logs/` 目录（包含日志）
- **不要删除** `reports/` 目录（包含报告）
- **不要覆盖** `.env` 配置文件
- **不要在定时任务运行时更新代码**

#### ✅ 必须操作
- 更新前**必须备份**数据库和配置文件
- 更新前**必须停止**正在运行的服务
- 更新后**必须测试**验证功能正常
- 更新后**必须监控**日志确认无误

## 🚀 最简单的更新流程

如果您想快速更新，可以直接使用以下命令：

```bash
# 一键检查和准备
cd /path/to/bio
./scripts/check_update_safety.sh

# 如果检查通过，执行更新
git pull origin main
pip install -r requirements.txt
python -m backend test-sources

# 查看日志确认正常
tail -f logs/paper_push_*.log
```

## 🆘 遇到问题怎么办？

### 如果更新后出现问题：

1. **立即查看日志**
   ```bash
   tail -100 logs/paper_push_*.log | grep ERROR
   ```

2. **快速回滚**
   ```bash
   git log --oneline -10  # 查看历史版本
   git reset --hard <之前的版本hash>
   ```

3. **恢复备份**
   ```bash
   cp data/paper_push.db.backup.最新时间戳 data/paper_push.db
   ```

### 常见问题及解决方案：

问题在 [生产环境代码更新指南](./生产环境代码更新指南.md) 的"常见问题处理"章节有详细说明。

## 📖 建议阅读顺序

1. **首次更新**：先阅读 [生产环境代码更新指南](./生产环境代码更新指南.md) 了解完整流程
2. **日常更新**：参考 [代码更新速查表](./代码更新速查表.md) 快速执行
3. **遇到问题**：查阅指南中的"常见问题处理"章节

## 💡 最佳实践

1. **选择合适的更新时间**
   - 避开定时任务运行时间（如果设置的是早上8:30，在其他时间更新）
   - 选择业务低峰期
   - 预留足够时间观察和处理问题

2. **渐进式更新**
   - 先在测试环境验证
   - 如果有多台服务器，先更新一台观察
   - 确认无问题后再全部更新

3. **做好记录**
   - 记录更新时间和版本
   - 记录遇到的问题和解决方案
   - 保留最近几次的备份

## 🔗 相关命令快速参考

```bash
# 查看当前版本
git log -1 --oneline

# 查看待更新内容
git fetch origin && git log HEAD..origin/main --oneline

# 运行安全检查
./scripts/check_update_safety.sh

# 备份数据库
cp data/paper_push.db data/paper_push.db.backup.$(date +%Y%m%d_%H%M%S)

# 查看日志
tail -f logs/paper_push_*.log

# 测试数据源
python -m backend test-sources
```

---

**总结**：更新代码时最重要的是**备份数据、停止服务、测试验证**。遇到问题不要慌，有备份就可以快速回滚。

如有任何疑问，请查阅 [生产环境代码更新指南](./生产环境代码更新指南.md) 获取详细说明。
